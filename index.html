<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase AI Logic MVP - Gemini Developer API (1.5 Flash) với MathJax</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax CDN (Configuration before script load) -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']], // Use $...$ and \(...)\ for inline math
                displayMath: [['$$', '$$'], ['\\[', '\\]']], // Use $$...$$ and \[...\] for display math
                processEscapes: true, // Allows using \$ for a literal dollar sign
                processEnvironments: true, // Enables LaTeX environments like \begin{align}
            },
            // The problematic 'options' block has been completely removed.
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom CSS for spinners and specific elements not easily covered by Tailwind */
        body {
            font-family: sans-serif;
            background-color: #f4f4f4;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .large-spinner { /* Used for internal message spinner now */
            width: 20px; /* Smaller for inline use */
            height: 20px;
            border-width: 3px; /* Thinner border */
            border-left-color: #3b82f6; /* Tailwind blue-500 */
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure MathJax elements are properly rendered within the container */
        .chat-container-content { /* New class for content containers */
            min-height: 120px; /* Ensure minimum height for output area */
            line-height: 1.6; /* Tăng khoảng cách dòng để dễ đọc hơn */
            font-size: 1.1rem; /* Tăng kích thước chữ */
            overflow-y: auto; /* Allow vertical scrolling for chat history */
            overflow-x: hidden; /* Prevent horizontal scroll on container itself */
            display: flex; /* Flex container for messages */
            flex-direction: column; /* Stack messages vertically */
        }
        
        /* Message bubble styling */
        .chat-message {
            max-width: 90%; /* Max width for chat bubbles */
            padding: 0.8em 1em;
            border-radius: 0.75em; /* Rounded corners */
            margin-bottom: 0.75em; /* Space between messages */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow for depth */
            word-wrap: break-word; /* Ensure long words break */
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
        }
        .user-message {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-900 */
            align-self: flex-end; /* Align to the right */
        }
        .ai-message {
            background-color: #eff6ff; /* Tailwind blue-100 */
            color: #1e40af; /* Tailwind blue-900 */
            align-self: flex-start; /* Align to the left */
        }

        /* Styling for #responseContent children to improve readability for structured answers */
        /* These styles now apply to content WITHIN .ai-message bubbles */
        .ai-message h1,
        .ai-message h2,
        .ai-message h3,
        .ai-message h4,
        .ai-message h5,
        .ai-message h6 {
            margin-top: 1.2em; /* Add space above headings */
            margin-bottom: 0.6em;
            font-weight: 600; /* Semi-bold */
            color: #2c5282; /* A darker blue for headings */
        }
        .ai-message h3 {
            font-size: 1.4rem; /* Slightly smaller for chat bubble context */
            border-bottom: 1px solid #ebf8ff; /* Light border under h3 */
            padding-bottom: 0.2em;
        }
        .ai-message h4 {
            font-size: 1.2rem; /* Slightly smaller for chat bubble context */
            color: #3182ce; /* A slightly lighter blue for h4 */
        }
        .ai-message p {
            margin-bottom: 0.8em; /* Space between paragraphs */
        }
        .ai-message ul,
        .ai-message ol {
            margin-left: 1.5em; /* Indent lists */
            margin-bottom: 0.8em;
            list-style-position: outside; /* Ensure bullets/numbers are outside content */
        }
        .ai-message li {
            margin-bottom: 0.4em; /* Space between list items */
        }

        /* Enhanced styling for MathJax Display equations within messages */
        .ai-message .MathJax_Display {
            background-color: #e0f2fe; /* Lighter blue background for equations in bubbles */
            border-left: 4px solid #63b3ed; /* Blue left border */
            padding: 0.8em; /* Padding around the equation */
            border-radius: 0.5em; /* Slightly rounded corners */
            margin: 1.2em 0 !important; /* Override default MathJax margin */
            overflow-x: auto; /* Ensure horizontal scrolling for long equations within their box */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow */
        }
        /* Ensure inline math is also readable, though usually MathJax handles this well */
        .ai-message .MathJax_CHTML {
            line-height: 1.2; /* Ensure inline math doesn't affect line height too much */
        }

        /* Back to Top Button Styling (Hidden by default) */
        #backToTopBtn {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px); /* Start slightly down */
        }
        #backToTopBtn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0); /* Slide up to position */
        }

        /* Interactive Link Styling */
        .interactive-link {
            display: inline-block;
            background-color: #e0f2fe; /* Light blue background */
            color: #1e40af; /* Dark blue text */
            padding: 0.2em 0.6em;
            border-radius: 0.3em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: 500;
            border: 1px solid #90cdf4; /* Light blue border */
            text-decoration: none; /* Remove underline for consistency */
            margin: 0.1em; /* Add a small margin for spacing */
        }
        .interactive-link:hover {
            background-color: #bfdbfe; /* Slightly darker blue on hover */
            transform: translateY(-1px); /* Slight lift effect */
        }
        .interactive-link:active {
            transform: translateY(0); /* Return to original position on click */
        }

        /* Completed Topic Styling */
        .interactive-link.completed-topic {
            text-decoration: line-through;
            opacity: 0.7;
            background-color: #dbeafe; /* Lightest blue */
            color: #60a5fa; /* Muted blue */
            border-color: #93c5fd; /* Muted border blue */
        }
        .interactive-link.completed-topic:hover {
            background-color: #bfdbfe; /* Still hover effect, but from a muted base */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center p-5">
    <h1 class="text-4xl font-extrabold text-blue-700 mb-4 text-center">Ứng dụng AI Toán học</h1>
    <h2 class="text-lg text-gray-600 mb-8 text-center">(Sử dụng Gemini 2.5 Flash và MathJax)</h2>

    <!-- Main Chat Content Area -->
    <div class="flex-grow w-full max-w-7xl flex flex-col">
        <!-- Tab Navigation -->
        <div id="tabContainer" class="flex border-b border-gray-200 mb-4 bg-white rounded-t-xl shadow-sm">
            <button id="solutionTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-blue-600 border-b-2 border-blue-600 hover:bg-blue-50 focus:outline-none rounded-tl-xl">
                Lời giải
            </button>
            <button id="reviewTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:bg-blue-50 focus:outline-none rounded-tr-xl">
                Ôn tập
            </button>
        </div>

        <div class="w-full h-full bg-white p-6 rounded-b-xl shadow-lg flex flex-col">
            <!-- Solution Content -->
            <div id="solutionContent" class="flex-grow flex flex-col">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Phản hồi từ AI</h3>
                <div id="solutionResponseContainer"
                     class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content"
                >
                    <!-- Messages will be dynamically added here -->
                    <p id="solutionPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Kết quả sẽ hiển thị ở đây...</p>
                </div>
                <p class="text-sm text-gray-600 mt-4 italic text-center">
                    Để có lời giải chuẩn như sách giáo khoa, hãy yêu cầu AI trình bày chi tiết từng bước và sử dụng LaTeX cho mọi công thức.
                </p>
            </div>

            <!-- Review Content (initially hidden) -->
            <div id="reviewContent" class="flex-grow flex-col hidden">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Lộ trình và Bài tập Ôn tập</h3>
                <div id="reviewResponseContainer"
                     class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content"
                >
                    <p id="reviewPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Nhập yêu cầu để tạo lộ trình ôn tập hoặc câu hỏi...</p>
                </div>
                <p class="text-sm text-gray-600 mt-4 italic text-center">
                    Ví dụ: "Tạo lộ trình ôn tập môn Toán lớp 12 chương Giải tích". Hoặc "Tạo 3 câu hỏi trắc nghiệm về đạo hàm".
                </p>
            </div>
        </div>
    </div>

    <!-- Fixed Input Footer -->
    <div id="chatInputFooter" 
         class="fixed bottom-0 left-0 right-0 w-full bg-white p-4 shadow-xl z-40">
        <div class="max-w-7xl mx-auto">
            <!-- Input and Button Row -->
            <div class="flex items-end space-x-2">
                <textarea id="promptInput" rows="1"
                          class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 resize-y"
                          placeholder="Nhập yêu cầu của bạn..."
                ></textarea>
                <button id="sendPromptButton"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out text-lg font-semibold flex items-center justify-center h-fit"
                >
                    <span id="buttonText">Gửi</span>
                    <div id="buttonSpinner" class="spinner ml-2 hidden"></div>
                </button>
            </div>
            <!-- Status Message (below the input/button row) -->
            <p id="statusMessage" class="status-message text-sm text-center mt-2"></p>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Quay lại đầu trang"
            class="fixed right-5 md:right-8 lg:right-10 
                   bg-blue-600 text-white p-3 rounded-full shadow-lg 
                   hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 
                   transition-all duration-300 ease-in-out text-xl z-50">
        &#x2191; <!-- Unicode for an upward arrow -->
    </button>

    <script type="module">
        // Import các module Firebase cần thiết
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";

        // Cấu hình Firebase của bạn (giữ nguyên như bạn đã cung cấp)
        const firebaseConfig = {
            apiKey: "AIzaSyAI2tN9qy9JqCySLkbTRqgGALlJfuTjg88",
            authDomain: "shopee-3eabb.firebaseapp.com",
            projectId: "shopee-3eabb",
            storageBucket: "shopee-3eabb.firebasestorage.app",
            messagingSenderId: "19651189872",
            appId: "1:19651189872:web:fb0fff66e8c98ceb5928b5"
        };

        // Khởi tạo ứng dụng Firebase
        const app = initializeApp(firebaseConfig);
        console.log("Firebase App initialized!");

        // Lấy các phần tử DOM
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');

        // Tab and Content Elements
        const solutionTabBtn = document.getElementById('solutionTabBtn');
        const reviewTabBtn = document.getElementById('reviewTabBtn');
        const solutionContent = document.getElementById('solutionContent');
        const reviewContent = document.getElementById('reviewContent');
        const solutionResponseContainer = document.getElementById('solutionResponseContainer');
        const reviewResponseContainer = document.getElementById('reviewResponseContainer');
        const solutionPlaceholder = document.getElementById('solutionPlaceholder');
        const reviewPlaceholder = document.getElementById('reviewPlaceholder');

        const chatInputFooter = document.getElementById('chatInputFooter');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Global state for current chat session and content container
        let model;
        let solutionChat;
        let reviewChat;
        let currentChatSession;
        let currentContentContainerElement;
        let currentActiveTab = 'solution'; // Default active tab
        let completedTopics = []; // NEW: Stores prompts of completed learning topics

        // Constants for quiz and interactive link processing
        const QUIZ_PLACEHOLDER_PREFIX = "QUIZ_PLACEHOLDER_";
        const QUIZ_BLOCK_REGEX = /```(?:quiz|json)\n([\s\S]*?)\n```/g;
        const INTERACTIVE_LINK_REGEX = /(?<!\]\()\B\[(.*?)\]\{(?:\"prompt\":\"(.*?)\")?\}/g;
        const BASIC_LINK_REGEX = /\[(.*?)\]/g;

        // ***FIX: Corrected the system prompt to allow LaTeX in JSON***
        const LEARNING_MODE_SYSTEM_PROMPT = `Bạn là một trợ lý ôn tập và học tập AI chuyên biệt trong lĩnh vực toán học. Mục tiêu của bạn là giúp người dùng ôn tập hiệu quả thông qua lộ trình học tập và các nội dung lý thuyết chi tiết.

**Quy tắc phản hồi chính:**
1.  **Lộ trình ôn tập:** Khi người dùng yêu cầu lộ trình ôn tập, bạn phải trả về một danh sách các mục ôn tập dưới dạng Markdown. **Cực kỳ quan trọng: Mỗi mục trong danh sách này phải là một liên kết tương tác với một lời nhắc (prompt) ẩn đi để yêu cầu giải thích lý thuyết chi tiết về mục đó.**
    * **Định dạng liên kết tương tác PHẢI là:** \`[Tên mục ôn tập]{"prompt":"Giải thích chi tiết về [Tên mục ôn tập] bao gồm định nghĩa, công thức, tính chất và các ví dụ minh họa."}\`
2.  **Tạo bài tập/quiz:** Nếu người dùng *trực tiếp* yêu cầu tạo câu hỏi hoặc bài tập, bạn PHẢI trả về một khối JSON hợp lệ được bao bọc trong khối mã Markdown. Nếu người dùng yêu cầu nhiều câu hỏi, bạn có thể trả về một mảng các đối tượng JSON.
    * **Định dạng khối mã PHẢI là:** Khối mã PHẢI bắt đầu bằng \`\`\`quiz trên một dòng riêng và kết thúc bằng \`\`\` trên một dòng riêng. TOÀN BỘ nội dung JSON (một đối tượng hoặc một mảng các đối tượng) phải nằm giữa hai dòng này.
    * **Ví dụ định dạng đúng:**
        \`\`\`quiz
        {
            "type": "multiple_choice",
            "title": "Câu hỏi về Đạo hàm",
            "question": "Đạo hàm của hàm số $y = x^3$ là gì?",
            "options": ["$3x^2$", "$x^2$", "$3x$"],
            "answer": "$3x^2$",
            "explanation": "Áp dụng công thức $(x^n)' = n*x^{n-1}$, ta có $(x^3)' = 3*x^{3-1} = 3x^2$."
        }
        \`\`\`
    * **Quan trọng:** Các giá trị chuỗi bên trong JSON (question, options, answer, etc.) phải là văn bản thuần túy. Tuy nhiên, bạn **PHẢI** sử dụng dấu đô la (ví dụ: \`$x^2$\` cho công thức nội dòng và \`$$...$$\` cho công thức khối) để bao bọc **TẤT CẢ** các công thức và biểu thức toán học bên trong các chuỗi JSON này để chúng có thể được hiển thị đúng.
3.  **Ngôn ngữ:** Luôn phản hồi bằng tiếng Việt.

Hãy tuân thủ nghiêm ngặt các quy tắc trên để đảm bảo trải nghiệm tương tác liền mạch cho người dùng.
`;


        // Hàm cập nhật trạng thái
        function updateStatus(type, message) {
            statusMessage.className = `status-message text-sm ${type}`;
            statusMessage.innerHTML = message;
        }

        updateStatus('text-yellow-600', "Firebase App đã khởi tạo.<br>Đang chờ khởi tạo AI Model...");

        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
            console.log("Generative Model instance created with model 'gemini-2.5-flash'!");
            
            solutionChat = model.startChat(); 
            console.log("Solution chat session started!");

            reviewChat = model.startChat({
                history: [
                    { role: "user", parts: [{ text: LEARNING_MODE_SYSTEM_PROMPT }] },
                    { role: "model", parts: [{ text: "Tôi đã hiểu vai trò của mình là trợ lý ôn tập. Hãy cho tôi biết bạn muốn ôn tập chủ đề gì hoặc tạo câu hỏi như thế nào!" }] }
                ]
            });
            console.log("Review chat session started with learning mode system prompt!");
            
            currentChatSession = solutionChat;
            currentContentContainerElement = solutionResponseContainer;
            
            updateStatus('text-green-600', "Generative Model instance đã tạo. Sẵn sàng gửi yêu cầu.");
        } catch (e) {
            console.error("Lỗi khi khởi tạo AI Model:", e);
            updateStatus('text-red-600', `Lỗi khởi tạo AI Model: ${e.message}.<br>Kiểm tra Console (F12) và đảm bảo Gemini API đã được kích hoạt cho dự án của bạn.`);
        }

        function appendMessage(text, senderType, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', senderType);

            if (isLoading) {
                messageDiv.innerHTML = `<div class="large-spinner"></div>`;
                messageDiv.spinner = messageDiv.querySelector('.large-spinner');
            } else {
                messageDiv.innerHTML = text;
            }
            
            currentContentContainerElement.appendChild(messageDiv);
            currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
            return messageDiv;
        }

        function extractAndReplaceQuizBlocks(text) {
            const extractedQuizzes = [];
            let quizIndex = 0;
            const cleanedText = text.replace(QUIZ_BLOCK_REGEX, (match, jsonContent) => {
                extractedQuizzes.push(jsonContent.trim());
                return `${QUIZ_PLACEHOLDER_PREFIX}${quizIndex++}`;
            });
            return { cleanedText, extractedQuizzes };
        }

        function preprocessText(text) {
            let processedText = text;
            processedText = processedText.replace(INTERACTIVE_LINK_REGEX, (match, linkText, promptValue) => {
                const decodedPrompt = promptValue ? decodeURIComponent(promptValue) : '';
                const isCompleted = completedTopics.includes(decodedPrompt);
                const completedClass = isCompleted ? ' completed-topic' : '';
                
                const dataAttribute = promptValue ? `data-prompt="${encodeURIComponent(promptValue)}"` : '';
                return `<span class="interactive-link${completedClass}" ${dataAttribute}>${linkText}</span>`;
            });
            return processedText;
        }

        function cleanJSON(jsonString) {
            let cleaned = jsonString.trim();
            cleaned = cleaned.replace(/\/\*[\s\S]*?\*\/|\/\/.*/g, '');
            cleaned = cleaned.replace(/[“”‘’]/g, '"');
            cleaned = cleaned.replace(/,\s*([\}\]])/g, '$1');
            cleaned = cleaned.replace(/\\(?!["\\/bfnrtu])/g, '\\\\');
            return cleaned;
        }

        function renderQuiz(quizJson) {
            let html = `<div class="quiz-block border border-blue-200 rounded-lg p-4 my-3 bg-blue-50">`;
            html += `<p class="font-bold text-blue-800 mb-2">${quizJson.title || 'Bài tập'}</p>`;
            switch (quizJson.type) {
                case 'multiple_choice':
                    html += `<p class="mb-2">${quizJson.question}</p>`;
                    if (quizJson.options && Array.isArray(quizJson.options)) {
                        html += `<div class="space-y-2">`;
                        quizJson.options.forEach(opt => {
                             html += `<label class="flex items-center p-2 border rounded-md hover:bg-blue-100 cursor-pointer"><input type="radio" name="mcq-${Math.random()}" class="mr-2">${opt}</label>`;
                        });
                        html += `</div>`;
                    }
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án đúng:</b> ${quizJson.answer}<br><i>${quizJson.explanation || ''}</i></p></div>`;
                    break;
                case 'fill_in_the_blank':
                    html += `<p>${quizJson.question.replace(/__+/g, '<input type="text" class="border-b-2 border-gray-400 focus:border-blue-500 outline-none bg-transparent">')}</p>`;
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án đúng:</b> ${quizJson.answer}<br><i>${quizJson.explanation || ''}</i></p></div>`;
                    break;
                case 'short_answer':
                    html += `<p>${quizJson.question}</p><textarea class="w-full mt-2 p-2 border rounded-md"></textarea>`;
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án gợi ý:</b> ${quizJson.answer}<br><i>${quizJson.explanation || ''}</i></p></div>`;
                    break;
                case 'flashcard':
                    html += `<div class="flashcard bg-white p-4 border rounded shadow-sm text-center cursor-pointer">
                                <div class="front"><p class="text-lg font-semibold">${quizJson.front}</p></div>
                                <div class="back hidden"><p class="text-gray-700">${quizJson.back}</p></div>
                             </div>`;
                    break;
                default:
                    html += `<p>Loại bài tập không được hỗ trợ: ${quizJson.type}</p>`;
            }
            html += `</div>`;
            return html;
        }

        function insertRenderedQuizzes(htmlContent, extractedQuizzes) {
            let finalHtml = htmlContent;
            extractedQuizzes.forEach((quizRaw, index) => {
                const placeholder = `${QUIZ_PLACEHOLDER_PREFIX}${index}`;
                let quizHtml = ''; // Initialize as empty string to accumulate HTML

                try {
                    const cleanedQuizRaw = cleanJSON(quizRaw);
                    if (!cleanedQuizRaw) {
                        throw new Error("Khối quiz nhận được từ AI bị trống.");
                    }
                    const quizJson = JSON.parse(cleanedQuizRaw);

                    // Function to validate and render a single quiz object
                    const validateAndRender = (quizObject) => {
                        if (!quizObject || typeof quizObject !== 'object' || !quizObject.type) {
                            throw new Error(`Đối tượng quiz không hợp lệ hoặc thiếu thuộc tính "type". Dữ liệu: <pre class="whitespace-pre-wrap text-xs">${JSON.stringify(quizObject, null, 2)}</pre>`);
                        }
                        return renderQuiz(quizObject);
                    };

                    // Check if the parsed JSON is an array or a single object
                    if (Array.isArray(quizJson)) {
                        // It's an array of quizzes, iterate and render each one
                        quizJson.forEach(singleQuiz => {
                            quizHtml += validateAndRender(singleQuiz);
                        });
                    } else {
                        // It's a single quiz object
                        quizHtml = validateAndRender(quizJson);
                    }

                } catch (e) {
                    console.error(`Lỗi khi xử lý quiz ${index}:`, e);
                    // Display a more informative error message to the user
                    quizHtml = `<div class="bg-red-100 text-red-800 p-4 rounded-lg my-2">
                                    <p class="font-bold mb-2">Lỗi Xử Lý Bài Tập</p>
                                    <p class="text-sm">AI có thể đã tạo ra định dạng không đúng. Vui lòng thử lại yêu cầu.</p>
                                    <div class="mt-2 text-xs text-gray-700 bg-red-50 p-2 rounded"><b>Chi tiết lỗi:</b> ${e.message}</div>
                                </div>`;
                }
                finalHtml = finalHtml.replace(placeholder, quizHtml);
            });
            return finalHtml;
        }
        
        function addQuizEventListeners(container) {
            // Event listener for "Xem đáp án" buttons
            container.querySelectorAll('.quiz-block button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const answerParagraph = e.target.nextElementSibling;
                    if (answerParagraph) {
                        answerParagraph.classList.toggle('hidden');
                        e.target.textContent = answerParagraph.classList.contains('hidden') ? 'Xem đáp án' : 'Ẩn đáp án';
                    }
                });
            });

            // Event listener for flashcards
            container.querySelectorAll('.flashcard').forEach(card => {
                card.addEventListener('click', () => {
                    card.querySelector('.front').classList.toggle('hidden');
                    card.querySelector('.back').classList.toggle('hidden');
                });
            });
        }


        async function handleLearningPromptClick(linkElement) {
            const dataPrompt = linkElement.dataset.prompt;
            if (!dataPrompt) {
                console.warn("Interactive link clicked without data-prompt.");
                return;
            }

            const decodedPrompt = decodeURIComponent(dataPrompt);

            if (!completedTopics.includes(decodedPrompt)) {
                completedTopics.push(decodedPrompt);
                linkElement.classList.add('completed-topic');
            }

            await callGeminiAPI(decodedPrompt);
        }

        async function callGeminiAPI(promptOverride = null) {
            if (!model || !currentChatSession) {
                updateStatus('text-red-600', "Mô hình AI hoặc phiên trò chuyện chưa được khởi tạo.");
                return;
            }

            const promptText = promptOverride || promptInput.value.trim();
            if (!promptText) {
                updateStatus('text-red-600', "Vui lòng nhập lời nhắc!");
                return;
            }

            updateStatus('text-yellow-600', "Đang gửi yêu cầu đến Gemini...");
            
            if (currentActiveTab === 'solution') solutionPlaceholder.classList.add('hidden');
            else reviewPlaceholder.classList.add('hidden');

            appendMessage(promptText, 'user-message');
            if (!promptOverride) {
                promptInput.value = ''; 
            }

            const aiLoadingMessageDiv = appendMessage('', 'ai-message', true);

            buttonText.textContent = 'Đang gửi...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            try {
                const result = await currentChatSession.sendMessage(promptText);
                const response = result.response;
                const text = response.text();

                const { cleanedText, extractedQuizzes } = extractAndReplaceQuizBlocks(text);
                const preprocessedText = preprocessText(cleanedText);
                let htmlContent = marked.parse(preprocessedText); 
                htmlContent = insertRenderedQuizzes(htmlContent, extractedQuizzes);

                aiLoadingMessageDiv.innerHTML = htmlContent;
                if (aiLoadingMessageDiv.spinner) {
                    aiLoadingMessageDiv.spinner.remove();
                }

                if (typeof MathJax !== 'undefined') {
                    await MathJax.typesetPromise([aiLoadingMessageDiv]);
                } else {
                    console.warn("MathJax is not available.");
                }

                aiLoadingMessageDiv.querySelectorAll('.interactive-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleLearningPromptClick(e.currentTarget);
                    });
                });
                
                addQuizEventListeners(aiLoadingMessageDiv);

                currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
                updateStatus('text-green-600', "Đã nhận phản hồi từ Gemini.");
                console.log("Response text:", text);

            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                aiLoadingMessageDiv.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}. Vui lòng kiểm tra Console (F12).</p>`;
                if (aiLoadingMessageDiv.spinner) {
                    aiLoadingMessageDiv.spinner.remove();
                }
                currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
                updateStatus('text-red-600', `Lỗi khi gọi Gemini API: ${error.message}.`);
            } finally {
                buttonText.textContent = 'Gửi';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
                promptInput.focus();
            }
        }

        function switchTab(tabName) {
            currentActiveTab = tabName;

            solutionContent.classList.add('hidden');
            reviewContent.classList.add('hidden');

            solutionTabBtn.classList.remove('text-blue-600', 'border-blue-600');
            solutionTabBtn.classList.add('text-gray-600', 'border-transparent');
            reviewTabBtn.classList.remove('text-blue-600', 'border-blue-600');
            reviewTabBtn.classList.add('text-gray-600', 'border-transparent');

            if (tabName === 'solution') {
                solutionContent.classList.remove('hidden');
                solutionTabBtn.classList.add('text-blue-600', 'border-blue-600');
                solutionTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = solutionChat;
                currentContentContainerElement = solutionResponseContainer;
            } else if (tabName === 'review') {
                reviewContent.classList.remove('hidden');
                reviewTabBtn.classList.add('text-blue-600', 'border-blue-600');
                reviewTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = reviewChat;
                currentContentContainerElement = reviewResponseContainer;
            }
            
            adjustLayout();
            currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
        }

        if (sendPromptButton) {
            sendPromptButton.addEventListener("click", () => callGeminiAPI(null));
            promptInput.addEventListener("keydown", (event) => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    callGeminiAPI(null);
                }
            });
        } else {
            console.error("Không tìm thấy nút 'sendPromptButton'.");
            updateStatus('text-red-600', "Không tìm thấy nút gửi. Lỗi HTML?");
        }

        if (solutionTabBtn) {
            solutionTabBtn.addEventListener("click", () => switchTab('solution'));
        }
        if (reviewTabBtn) {
            reviewTabBtn.addEventListener("click", () => switchTab('review'));
        }

        function adjustLayout() {
            const footerHeight = chatInputFooter.offsetHeight;
            solutionResponseContainer.style.paddingBottom = `${footerHeight + 20}px`; 
            reviewResponseContainer.style.paddingBottom = `${footerHeight + 20}px`;
            backToTopBtn.style.bottom = `${footerHeight + 20}px`;
        }

        window.addEventListener('load', () => {
            adjustLayout();
            switchTab('solution');
        });
        window.addEventListener('resize', adjustLayout);

        window.addEventListener('scroll', () => {
            if (window.pageYOffset > window.innerHeight / 2) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>
