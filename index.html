<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase AI Logic MVP - Gemini Developer API (1.5 Flash) với MathJax</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax CDN (Configuration before script load) -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']], // Use $...$ and \(...)\ for inline math
                displayMath: [['$$', '$$'], ['\\[', '\\]']], // Use $$...$$ and \[...\] for display math
                processEscapes: true, // Allows using \$ for a literal dollar sign
                processEnvironments: true, // Enables LaTeX environments like \begin{align}
            },
            // The problematic 'options' block has been completely removed.
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom CSS for spinners and specific elements not easily covered by Tailwind */
        body {
            font-family: sans-serif;
            background-color: #f4f4f4;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .large-spinner { /* Used for internal message spinner now */
            width: 20px; /* Smaller for inline use */
            height: 20px;
            border-width: 3px; /* Thinner border */
            border-left-color: #3b82f6; /* Tailwind blue-500 */
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure MathJax elements are properly rendered within the container */
        .chat-container-content { /* New class for content containers */
            min-height: 120px; /* Ensure minimum height for output area */
            line-height: 1.6; /* Tăng khoảng cách dòng để dễ đọc hơn */
            font-size: 1.1rem; /* Tăng kích thước chữ */
            overflow-y: auto; /* Allow vertical scrolling for chat history */
            overflow-x: hidden; /* Prevent horizontal scroll on container itself */
            display: flex; /* Flex container for messages */
            flex-direction: column; /* Stack messages vertically */
        }
        
        /* Message bubble styling */
        .chat-message {
            max-width: 90%; /* Max width for chat bubbles */
            padding: 0.8em 1em;
            border-radius: 0.75em; /* Rounded corners */
            margin-bottom: 0.75em; /* Space between messages */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow for depth */
            word-wrap: break-word; /* Ensure long words break */
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
        }
        .user-message {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-900 */
            align-self: flex-end; /* Align to the right */
        }
        .ai-message {
            background-color: #eff6ff; /* Tailwind blue-100 */
            color: #1e40af; /* Tailwind blue-900 */
            align-self: flex-start; /* Align to the left */
        }

        /* Styling for #responseContent children to improve readability for structured answers */
        /* These styles now apply to content WITHIN .ai-message bubbles */
        .ai-message h1,
        .ai-message h2,
        .ai-message h3,
        .ai-message h4,
        .ai-message h5,
        .ai-message h6 {
            margin-top: 1.2em; /* Add space above headings */
            margin-bottom: 0.6em;
            font-weight: 600; /* Semi-bold */
            color: #2c5282; /* A darker blue for headings */
        }
        .ai-message h3 {
            font-size: 1.4rem; /* Slightly smaller for chat bubble context */
            border-bottom: 1px solid #ebf8ff; /* Light border under h3 */
            padding-bottom: 0.2em;
        }
        .ai-message h4 {
            font-size: 1.2rem; /* Slightly smaller for chat bubble context */
            color: #3182ce; /* A slightly lighter blue for h4 */
        }
        .ai-message p {
            margin-bottom: 0.8em; /* Space between paragraphs */
        }
        .ai-message ul,
        .ai-message ol {
            margin-left: 1.5em; /* Indent lists */
            margin-bottom: 0.8em;
            list-style-position: outside; /* Ensure bullets/numbers are outside content */
        }
        .ai-message li {
            margin-bottom: 0.4em; /* Space between list items */
        }

        /* Enhanced styling for MathJax Display equations within messages */
        .ai-message .MathJax_Display {
            background-color: #e0f2fe; /* Lighter blue background for equations in bubbles */
            border-left: 4px solid #63b3ed; /* Blue left border */
            padding: 0.8em; /* Padding around the equation */
            border-radius: 0.5em; /* Slightly rounded corners */
            margin: 1.2em 0 !important; /* Override default MathJax margin */
            overflow-x: auto; /* Ensure horizontal scrolling for long equations within their box */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow */
        }
        /* Ensure inline math is also readable, though usually MathJax handles this well */
        .ai-message .MathJax_CHTML {
            line-height: 1.2; /* Ensure inline math doesn't affect line height too much */
        }

        /* Back to Top Button Styling (Hidden by default) */
        #backToTopBtn {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px); /* Start slightly down */
        }
        #backToTopBtn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0); /* Slide up to position */
        }

        /* Interactive Link Styling */
        .interactive-link {
            display: inline-block;
            background-color: #e0f2fe; /* Light blue background */
            color: #1e40af; /* Dark blue text */
            padding: 0.2em 0.6em;
            border-radius: 0.3em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: 500;
            border: 1px solid #90cdf4; /* Light blue border */
            text-decoration: none; /* Remove underline for consistency */
            margin: 0.1em; /* Add a small margin for spacing */
        }
        .interactive-link:hover {
            background-color: #bfdbfe; /* Slightly darker blue on hover */
            transform: translateY(-1px); /* Slight lift effect */
        }
        .interactive-link:active {
            transform: translateY(0); /* Return to original position on click */
        }

        /* Completed Topic Styling */
        .interactive-link.completed-topic {
            text-decoration: line-through;
            opacity: 0.7;
            background-color: #dbeafe; /* Lightest blue */
            color: #60a5fa; /* Muted blue */
            border-color: #93c5fd; /* Muted border blue */
        }
        .interactive-link.completed-topic:hover {
            background-color: #bfdbfe; /* Still hover effect, but from a muted base */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center p-5">
    <h1 class="text-4xl font-extrabold text-blue-700 mb-4 text-center">Ứng dụng AI Toán học</h1>
    <h2 class="text-lg text-gray-600 mb-8 text-center">(Sử dụng Gemini 2.5 Flash và MathJax)</h2>

    <!-- Main Chat Content Area -->
    <div class="flex-grow w-full max-w-7xl flex flex-col">
        <!-- Tab Navigation -->
        <div id="tabContainer" class="flex border-b border-gray-200 mb-4 bg-white rounded-t-xl shadow-sm">
            <button id="solutionTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-blue-600 border-b-2 border-blue-600 hover:bg-blue-50 focus:outline-none rounded-tl-xl">
                Lời giải
            </button>
            <button id="reviewTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:bg-blue-50 focus:outline-none rounded-tr-xl">
                Ôn tập
            </button>
        </div>

        <div class="w-full h-full bg-white p-6 rounded-b-xl shadow-lg flex flex-col">
            <!-- Solution Content -->
            <div id="solutionContent" class="flex-grow flex flex-col">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Phản hồi từ AI</h3>
                <div id="solutionResponseContainer"
                     class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content"
                >
                    <!-- Messages will be dynamically added here -->
                    <p id="solutionPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Kết quả sẽ hiển thị ở đây...</p>
                </div>
                <p class="text-sm text-gray-600 mt-4 italic text-center">
                    Để có lời giải chuẩn như sách giáo khoa, hãy yêu cầu AI trình bày chi tiết từng bước và sử dụng LaTeX cho mọi công thức.
                </p>
            </div>

            <!-- Review Content (initially hidden) -->
            <div id="reviewContent" class="flex-grow flex-col hidden">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Lộ trình và Bài tập Ôn tập</h3>
                <div id="reviewResponseContainer"
                     class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content"
                >
                    <p id="reviewPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Nhập yêu cầu để tạo lộ trình ôn tập hoặc câu hỏi...</p>
                </div>
                <p class="text-sm text-gray-600 mt-4 italic text-center">
                    Ví dụ: "Tạo lộ trình ôn tập môn Toán lớp 12 chương Giải tích". Hoặc "Tạo 3 câu hỏi trắc nghiệm về đạo hàm".
                </p>
            </div>
        </div>
    </div>

    <!-- Fixed Input Footer -->
    <div id="chatInputFooter" 
         class="fixed bottom-0 left-0 right-0 w-full bg-white p-4 shadow-xl z-40">
        <div class="max-w-7xl mx-auto">
            <!-- Input and Button Row -->
            <div class="flex items-end space-x-2">
                <textarea id="promptInput" rows="1"
                          class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 resize-y"
                          placeholder="Nhập yêu cầu của bạn..."
                ></textarea>
                <button id="sendPromptButton"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out text-lg font-semibold flex items-center justify-center h-fit"
                >
                    <span id="buttonText">Gửi</span>
                    <div id="buttonSpinner" class="spinner ml-2 hidden"></div>
                </button>
            </div>
            <!-- Status Message (below the input/button row) -->
            <p id="statusMessage" class="status-message text-sm text-center mt-2"></p>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Quay lại đầu trang"
            class="fixed right-5 md:right-8 lg:right-10 
                   bg-blue-600 text-white p-3 rounded-full shadow-lg 
                   hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 
                   transition-all duration-300 ease-in-out text-xl z-50">
        &#x2191; <!-- Unicode for an upward arrow -->
    </button>

    <script type="module">
        // Import các module Firebase cần thiết
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";

        // Cấu hình Firebase của bạn (giữ nguyên như bạn đã cung cấp)
        const firebaseConfig = {
            apiKey: "AIzaSyAI2tN9qy9JqCySLkbTRqgGALlJfuTjg88",
            authDomain: "shopee-3eabb.firebaseapp.com",
            projectId: "shopee-3eabb",
            storageBucket: "shopee-3eabb.firebasestorage.app",
            messagingSenderId: "19651189872",
            appId: "1:19651189872:web:fb0fff66e8c98ceb5928b5"
        };

        // Khởi tạo ứng dụng Firebase
        const app = initializeApp(firebaseConfig);
        console.log("Firebase App initialized!");

        // Lấy các phần tử DOM
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');

        // Tab and Content Elements
        const solutionTabBtn = document.getElementById('solutionTabBtn');
        const reviewTabBtn = document.getElementById('reviewTabBtn');
        const solutionContent = document.getElementById('solutionContent');
        const reviewContent = document.getElementById('reviewContent');
        const solutionResponseContainer = document.getElementById('solutionResponseContainer');
        const reviewResponseContainer = document.getElementById('reviewResponseContainer');
        const solutionPlaceholder = document.getElementById('solutionPlaceholder');
        const reviewPlaceholder = document.getElementById('reviewPlaceholder');

        const chatInputFooter = document.getElementById('chatInputFooter');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Global state for current chat session and content container
        let model;
        let solutionChat;
        let reviewChat;
        let currentChatSession;
        let currentContentContainerElement;
        let currentActiveTab = 'solution'; // Default active tab
        let completedTopics = []; // NEW: Stores prompts of completed learning topics

        // Constants for quiz and interactive link processing
        const QUIZ_PLACEHOLDER_PREFIX = "QUIZ_PLACEHOLDER_";
        const QUIZ_BLOCK_REGEX = /```quiz([\s\S]*?)```/g;
        // Regex for [Text]{"prompt":"..."} or [Text] (basic link)
        // Updated to use negative lookbehind for robustness
        const INTERACTIVE_LINK_REGEX = /(?<!\]\()\B\[(.*?)\]\{(?:\"prompt\":\"(.*?)\")?\}/g;
        const BASIC_LINK_REGEX = /\[(.*?)\]/g;

        // SYSTEM PROMPT cho chế độ Ôn tập
const LEARNING_MODE_SYSTEM_PROMPT = `Bạn là một trợ lý ôn tập và học tập AI chuyên biệt trong lĩnh vực toán học. Mục tiêu của bạn là giúp người dùng ôn tập hiệu quả thông qua lộ trình học tập và các nội dung lý thuyết chi tiết.

**Quy tắc phản hồi chính:**
1.  **Lộ trình ôn tập:** Khi người dùng yêu cầu lộ trình ôn tập cho một chủ đề/chương cụ thể, bạn phải trả về một danh sách các mục ôn tập dưới dạng Markdown. **Cực kỳ quan trọng: Mỗi mục trong danh sách này phải là một liên kết tương tác với một lời nhắc (prompt) ẩn đi để yêu cầu giải thích lý thuyết chi tiết về mục đó.**
    *   **Định dạng liên kết tương tác PHẢI là:** \`[Tên mục ôn tập]{"prompt":"Giải thích chi tiết về [Tên mục ôn tập] bao gồm định nghĩa, công thức, tính chất và các ví dụ minh họa."}\`
    *   **Các ví dụ minh họa về liên kết lý thuyết trong lộ trình (TUÂN THỦ CÁC VÍ DỤ NÀY):**
        *   \`[Đạo hàm cơ bản]{"prompt":"Giải thích chi tiết về đạo hàm cơ bản, định nghĩa, công thức và ví dụ."}\`
        *   \`[Đạo hàm hàm hợp]{"prompt":"Trình bày lý thuyết về đạo hàm hàm hợp một cách đầy đủ và dễ hiểu."}\`
        *   \`[Cực trị hàm số]{"prompt":"Giải thích lý thuyết về cực trị hàm số, bao gồm các điều kiện cần và đủ."}\`
        *   \`[Tiệm cận đồ thị]{"prompt":"Cung cấp lý thuyết chi tiết về các dạng tiệm cận của đồ thị hàm số (đứng, ngang, xiên)."}\`
        *   \`[Tích phân xác định]{"prompt":"Giải thích định nghĩa, tính chất và phương pháp tính tích phân xác định."}\`
        *   \`[Ứng dụng tích phân vào hình học]{"prompt":"Trình bày lý thuyết về ứng dụng tích phân để tính diện tích hình phẳng và thể tích vật thể."}\`
        *   \`[Số phức cơ bản]{"prompt":"Giải thích về số phức cơ bản, bao gồm định nghĩa, các phép toán và biểu diễn hình học."}\`
        *   \`[Phương trình vi phân]{"prompt":"Cung cấp lý thuyết về phương trình vi phân cấp 1 và phương pháp giải."}\`
2.  **Tạo bài tập/quiz (Tùy chọn):** Nếu người dùng *trực tiếp* yêu cầu tạo câu hỏi hoặc bài tập, bạn có thể trả về một khối quiz dưới dạng JSON.
    *   **Định dạng JSON Quiz:** Tất cả các khối JSON quiz phải được bao bọc trong cú pháp khối mã Markdown đặc biệt: \`\`\`quiz...json...\`\`\`
    *   **Các loại quiz hỗ trợ (ĐẢM BẢO SỬ DỤNG HẾT CÁC LOẠI NÀY KHI PHÙ HỢP):**
        *   **multiple_choice:** \`{"type": "multiple_choice", "title": "...", "question": "...", "options": ["...", "...", "..."], "answer": "...", "explanation": "..."}\`
        *   **fill_in_the_blank:** \`{"type": "fill_in_the_blank", "title": "...", "question": "...", "answer": "...", "explanation": "..."}\`
        *   **short_answer:** \`{"type": "short_answer", "title": "...", "question": "...", "answer": "...", "explanation": "..."}\`
        *   **flashcard:** \`{"type": "flashcard", "title": "...", "front": "...", "back": "..."}\`
    *   **Quan trọng:** Các giá trị chuỗi bên trong JSON (question, options, answer, explanation, front, back) phải là **văn bản thuần túy**, không chứa bất kỳ định dạng Markdown, HTML, LaTeX hay ký tự đặc biệt nào khác ngoài các ký tự tiêu chuẩn trong JSON (ví dụ: không có dấu \`,\*,_,$,#, v.v. TRONG NỘI DUNG CHUỖI). Nếu có LaTeX, hãy đặt nó trực tiếp trong chuỗi mà không dùng dấu đô la hoặc dấu ngoặc vuông LaTeX.
3.  **Văn bản hỗ trợ:** Bạn có thể xen kẽ văn bản giải thích thông thường (Markdown) giữa các khối lý thuyết hoặc quiz.
4.  **Ngôn ngữ:** Luôn phản hồi bằng tiếng Việt.

Hãy tuân thủ nghiêm ngặt các quy tắc trên để đảm bảo trải nghiệm tương tác liền mạch cho người dùng.
`;


        // Hàm cập nhật trạng thái
        function updateStatus(type, message) {
            statusMessage.className = `status-message text-sm ${type}`;
            statusMessage.innerHTML = message;
        }

        updateStatus('text-yellow-600', "Firebase App đã khởi tạo.<br>Đang chờ khởi tạo AI Model...");

        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash-preview-05-20" });
            console.log("Generative Model instance created with model 'gemini-2.5-flash-preview-05-20'!");
            
            // Initialize solution chat without specific history (general math problem solving)
            solutionChat = model.startChat(); 
            console.log("Solution chat session started!");

            // Initialize review chat with system prompt for learning mode
            reviewChat = model.startChat({
                history: [
                    {
                        role: "user",
                        parts: [{ text: LEARNING_MODE_SYSTEM_PROMPT }] // System prompt as initial user message
                    },
                    {
                        role: "model",
                        parts: [{ text: "Tôi đã hiểu vai trò của mình là trợ lý ôn tập. Hãy cho tôi biết bạn muốn ôn tập chủ đề gì hoặc tạo câu hỏi như thế nào!" }] // AI confirmation
                    }
                ]
            });
            console.log("Review chat session started with learning mode system prompt!");
            
            // Set initial active session and container
            currentChatSession = solutionChat;
            currentContentContainerElement = solutionResponseContainer;
            
            updateStatus('text-green-600', "Generative Model instance đã tạo. Sẵn sàng gửi yêu cầu.");
        } catch (e) {
            console.error("Lỗi khi khởi tạo AI Model:", e);
            updateStatus('text-red-600', `Lỗi khởi tạo AI Model: ${e.message}.<br>Kiểm tra Console (F12) và đảm bảo Gemini API đã được kích hoạt cho dự án của bạn.`);
        }

        // Helper function to create and append a message element
        function appendMessage(text, senderType, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', senderType);

            if (isLoading) {
                messageDiv.innerHTML = `<div class="large-spinner"></div>`;
                messageDiv.spinner = messageDiv.querySelector('.large-spinner');
            } else {
                messageDiv.innerHTML = text;
            }
            
            // Append to the currently active content container
            currentContentContainerElement.appendChild(messageDiv);
            currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight; // Auto-scroll to bottom
            return messageDiv; // Return the created message div for potential updates
        }

        /**
         * Extracts raw quiz JSON blocks (```quiz...```) from the text,
         * replaces them with placeholders, and returns the cleaned text
         * along with the extracted JSON blocks.
         * @param {string} text The raw text from AI response.
         * @returns {{cleanedText: string, extractedQuizzes: Array<string>}}
         */
        function extractAndReplaceQuizBlocks(text) {
            const extractedQuizzes = [];
            let quizIndex = 0;
            const cleanedText = text.replace(QUIZ_BLOCK_REGEX, (match, jsonContent) => {
                extractedQuizzes.push(jsonContent.trim());
                return `${QUIZ_PLACEHOLDER_PREFIX}${quizIndex++}`;
            });
            return { cleanedText, extractedQuizzes };
        }

        /**
         * Preprocesses the text to convert custom interactive link patterns
         * into clickable HTML spans.
         * Pattern: [Link Text]{"prompt":"Optional prompt to send to AI"} or [Link Text]
         * @param {string} text The text to preprocess.
         * @returns {string} The processed HTML string.
         */
        function preprocessText(text) {
            let processedText = text;

            // Process specific interactive links: [Text]{"prompt":"..."}
            // Uses a lookbehind assertion to ensure it's not part of a markdown link [text](url)
            // or an image ![text](url)
            processedText = processedText.replace(INTERACTIVE_LINK_REGEX, (match, linkText, promptValue) => {
                // If a promptValue is present, encode it for data-attribute
                const decodedPrompt = promptValue ? decodeURIComponent(promptValue) : '';
                const isCompleted = completedTopics.includes(decodedPrompt);
                const completedClass = isCompleted ? ' completed-topic' : '';
                
                const dataAttribute = promptValue ? `data-prompt="${encodeURIComponent(promptValue)}"` : '';
                return `<span class="interactive-link${completedClass}" ${dataAttribute}>${linkText}</span>`;
            });
            
            // For now, simple [text] links are handled by marked.js (as standard Markdown links).
            // If we need custom behavior for [text] without prompt, we'd add another regex here.

            return processedText;
        }

        /**
         * Attempts to clean a raw JSON string to make it parsable.
         * This is a simplified version and may need more robust handling
         * for complex edge cases.
         * @param {string} jsonString The raw JSON string.
         * @returns {string} The cleaned JSON string.
         */
        function cleanJSON(jsonString) {
            // Remove common issues:
            // 1. Remove newlines and tabs within content, but keep structure newlines
            let cleaned = jsonString.replace(/[\n\r\t]+/g, ' ').replace(/\s+/g, ' ').trim();
            // 2. Remove problematic characters that often appear from AI outputs
            cleaned = cleaned.replace(/[“”‘’]/g, '"'); // Replace smart quotes with straight quotes
            cleaned = cleaned.replace(/\\(?!["\\/bfnrtu])/g, ''); // Remove invalid backslashes (keep valid ones)
            // 3. Ensure proper quotes for keys/values if AI sometimes misses them (complex, usually better with system prompt)
            // For simple cases, replace any leading/trailing spaces for robustness before parsing.
            return cleaned;
        }

        /**
         * Renders a single quiz JSON object into its HTML representation.
         * This is a placeholder and needs full implementation for each quiz type.
         * @param {object} quizJson Parsed quiz JSON object.
         * @returns {string} HTML string for the quiz.
         */
        function renderQuiz(quizJson) {
            if (!quizJson || !quizJson.type) {
                return `<div class="bg-red-100 text-red-700 p-3 rounded-md my-2">Error: Invalid quiz JSON.</div>`;
            }
            let html = `<div class="quiz-block border border-blue-200 rounded-lg p-4 my-3 bg-blue-50">`;
            html += `<p class="font-bold text-blue-800 mb-2">${quizJson.title || 'Quiz'}</p>`;
            switch (quizJson.type) {
                case 'multiple_choice':
                    html += `<p>${quizJson.question}</p>`;
                    if (quizJson.options && Array.isArray(quizJson.options)) {
                        html += `<ul class="list-disc ml-5 mt-2">`;
                        quizJson.options.forEach(opt => {
                            html += `<li>${opt}</li>`;
                        });
                        html += `</ul>`;
                    }
                    html += `<button class="mt-3 bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button>`;
                    break;
                case 'fill_in_the_blank':
                    html += `<p>${quizJson.question.replace(/__+/g, '_______')}</p>`;
                    html += `<button class="mt-3 bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button>`;
                    break;
                case 'short_answer':
                    html += `<p>${quizJson.question}</p>`;
                    html += `<button class="mt-3 bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button>`;
                    break;
                case 'flashcard':
                    html += `<div class="flashcard bg-white p-4 border rounded shadow-sm text-center">
                                <p class="text-lg font-semibold">${quizJson.front}</p>
                                <button class="mt-3 bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm">Lật thẻ</button>
                                <p class="text-gray-600 mt-2 hidden">${quizJson.back}</p>
                            </div>`;
                    break;
                default:
                    html += `<p>Unsupported quiz type: ${quizJson.type}</p>`;
            }
            html += `</div>`;
            return html;
        }

        /**
         * Inserts the rendered quiz HTML back into the main content
         * at the positions of their placeholders.
         * @param {string} htmlContent The HTML content with placeholders.
         * @param {Array<string>} extractedQuizzes Raw JSON strings of quizzes.
         * @returns {string} HTML content with quizzes rendered.
         */
        function insertRenderedQuizzes(htmlContent, extractedQuizzes) {
            let finalHtml = htmlContent;
            extractedQuizzes.forEach((quizRaw, index) => {
                const placeholder = `${QUIZ_PLACEHOLDER_PREFIX}${index}`;
                let quizHtml = `<div class="bg-red-100 text-red-700 p-3 rounded-md my-2">Lỗi phân tích JSON quiz. AI có thể đã tạo sai định dạng.</div>`; // Default error message

                try {
                    const cleanedQuizRaw = cleanJSON(quizRaw);
                    const quizJson = JSON.parse(cleanedQuizRaw);
                    quizHtml = renderQuiz(quizJson); // Render the quiz
                } catch (e) {
                    console.error(`Error parsing or rendering quiz ${index}:`, e, "Raw JSON:", quizRaw);
                }
                finalHtml = finalHtml.replace(placeholder, quizHtml);
            });
            return finalHtml;
        }

        /**
         * Handles the click event for learning-mode interactive links.
         * Marks the topic as completed and sends a new prompt to AI.
         * @param {HTMLElement} linkElement The clicked span.interactive-link element.
         */
        async function handleLearningPromptClick(linkElement) {
            const dataPrompt = linkElement.dataset.prompt;
            if (!dataPrompt) {
                console.warn("Interactive link clicked without data-prompt.");
                return;
            }

            const decodedPrompt = decodeURIComponent(dataPrompt);

            // Mark as completed and update UI
            if (!completedTopics.includes(decodedPrompt)) {
                completedTopics.push(decodedPrompt);
                linkElement.classList.add('completed-topic');
                // You would typically save this to a persistent storage (e.g., Firebase, Local Storage) here.
                // For this single-file MVP, it's session-only.
                console.log("Completed topics:", completedTopics);
            }

            // Send the prompt to AI
            await callGeminiAPI(decodedPrompt);
        }

        // Hàm gọi API Gemini và xử lý phản hồi
        async function callGeminiAPI(promptOverride = null) {
            if (!model || !currentChatSession) {
                updateStatus('text-red-600', "Mô hình AI hoặc phiên trò chuyện chưa được khởi tạo. Vui lòng kiểm tra console để biết lỗi.");
                return;
            }

            const promptText = promptOverride || promptInput.value.trim();
            if (!promptText) {
                updateStatus('text-red-600', "Vui lòng nhập lời nhắc!");
                return;
            }

            // --- Start Loading State ---
            updateStatus('text-yellow-600', "Đang gửi yêu cầu đến Gemini...");
            
            // Hide the placeholder of the active tab
            if (currentActiveTab === 'solution' && !solutionPlaceholder.classList.contains('hidden')) {
                solutionPlaceholder.classList.add('hidden');
            } else if (currentActiveTab === 'review' && !reviewPlaceholder.classList.contains('hidden')) {
                reviewPlaceholder.classList.add('hidden');
            }

            // Append user's message
            appendMessage(promptText, 'user-message');
            if (!promptOverride) { // Only clear input if not an internal override
                promptInput.value = ''; 
            }

            // Append AI's loading message placeholder
            const aiLoadingMessageDiv = appendMessage('', 'ai-message', true);

            buttonText.textContent = 'Đang gửi...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;
            // --- End Loading State ---

            try {
                const result = await currentChatSession.sendMessage(promptText);
                const response = result.response;
                const text = response.text();

                // Step 1: Extract quiz blocks
                const { cleanedText, extractedQuizzes } = extractAndReplaceQuizBlocks(text);

                // Step 2: Preprocess custom interactive links (now checks for completed status)
                const preprocessedText = preprocessText(cleanedText);

                // Step 3: Convert Markdown to HTML
                let htmlContent = marked.parse(preprocessedText); 

                // Step 4: Insert rendered quizzes back into HTML
                htmlContent = insertRenderedQuizzes(htmlContent, extractedQuizzes);

                // Update the AI's loading message div with actual content
                aiLoadingMessageDiv.innerHTML = htmlContent;
                if (aiLoadingMessageDiv.spinner) {
                    aiLoadingMessageDiv.spinner.remove();
                }

                // Yêu cầu MathJax xử lý nội dung mới để render các công thức toán học
                if (typeof MathJax !== 'undefined') {
                    await MathJax.typesetPromise([aiLoadingMessageDiv]);
                } else {
                    console.warn("MathJax chưa được tải hoặc không khả dụng.");
                }

                // Attach event listeners to interactive links
                aiLoadingMessageDiv.querySelectorAll('.interactive-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent event from bubbling up to parent handlers if any
                        handleLearningPromptClick(e.currentTarget);
                    });
                });
                
                // Add event listeners for flashcard flip (example)
                aiLoadingMessageDiv.querySelectorAll('.flashcard button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const flashcard = e.target.closest('.flashcard');
                        const backContent = flashcard.querySelector('.text-gray-600');
                        if (backContent) {
                            backContent.classList.toggle('hidden');
                            e.target.textContent = backContent.classList.contains('hidden') ? 'Lật thẻ' : 'Ẩn đáp án';
                        }
                    });
                });


                // --- End Loading & Show Content State ---
                currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
                updateStatus('text-green-600', "Đã nhận phản hồi từ Gemini.");
                console.log("Response text:", text);

            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                aiLoadingMessageDiv.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}. Vui lòng kiểm tra Console (F12) để biết thêm chi tiết.</p>`;
                if (aiLoadingMessageDiv.spinner) {
                    aiLoadingMessageDiv.spinner.remove();
                }
                currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
                updateStatus('text-red-600', `Lỗi khi gọi Gemini API: ${error.message}.`);
            } finally {
                buttonText.textContent = 'Gửi';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
                promptInput.focus();
            }
        }

        // Tab switching function
        function switchTab(tabName) {
            currentActiveTab = tabName;

            // Hide all content containers
            solutionContent.classList.add('hidden');
            reviewContent.classList.add('hidden');

            // Deactivate all tab buttons
            solutionTabBtn.classList.remove('text-blue-600', 'border-blue-600');
            solutionTabBtn.classList.add('text-gray-600', 'border-transparent');
            reviewTabBtn.classList.remove('text-blue-600', 'border-blue-600');
            reviewTabBtn.classList.add('text-gray-600', 'border-transparent');

            // Show selected tab content and activate button
            if (tabName === 'solution') {
                solutionContent.classList.remove('hidden');
                solutionTabBtn.classList.add('text-blue-600', 'border-blue-600');
                solutionTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = solutionChat;
                currentContentContainerElement = solutionResponseContainer;
            } else if (tabName === 'review') {
                reviewContent.classList.remove('hidden');
                reviewTabBtn.classList.add('text-blue-600', 'border-blue-600');
                reviewTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = reviewChat;
                currentContentContainerElement = reviewResponseContainer;
            }
            
            // Adjust layout after tab switch to ensure correct padding for footer
            adjustLayout();
            currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight; // Scroll to bottom of new tab
        }

        // Gán sự kiện click cho nút Gửi
        if (sendPromptButton) {
            sendPromptButton.addEventListener("click", () => callGeminiAPI(null));
            promptInput.addEventListener("keydown", (event) => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    callGeminiAPI(null);
                }
            });
        } else {
            console.error("Không tìm thấy nút 'sendPromptButton'.");
            updateStatus('text-red-600', "Không tìm thấy nút gửi. Lỗi HTML?");
        }

        // Gán sự kiện click cho nút tab
        if (solutionTabBtn) {
            solutionTabBtn.addEventListener("click", () => switchTab('solution'));
        }
        if (reviewTabBtn) {
            reviewTabBtn.addEventListener("click", () => switchTab('review'));
        }

        // --- Layout Adjustment and Back to Top Button Logic ---
        function adjustLayout() {
            const footerHeight = chatInputFooter.offsetHeight;
            // Add padding to the scrollable chat container to prevent content from being hidden by the fixed footer
            // Use the currently active content container
            solutionResponseContainer.style.paddingBottom = `${footerHeight + 20}px`; 
            reviewResponseContainer.style.paddingBottom = `${footerHeight + 20}px`;

            // Position the back to top button above the footer
            backToTopBtn.style.bottom = `${footerHeight + 20}px`;
        }

        window.addEventListener('load', () => {
            adjustLayout(); // Initial layout adjustment
            switchTab('solution'); // Ensure "Lời giải" tab is active on load
        });
        window.addEventListener('resize', adjustLayout); // Re-adjust on window resize

        window.addEventListener('scroll', () => {
            // Show/hide back to top button based on scroll position
            if (window.pageYOffset > window.innerHeight / 2) { // Show if scrolled down past half viewport height
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Smooth scroll to top of the page
            });
        });
        // --- End Layout Adjustment and Back to Top Button Logic ---
    </script>
</body>
</html>
