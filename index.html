<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase AI Logic MVP - Gemini Developer API (1.5 Flash) với MathJax</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax CDN (Configuration before script load) -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']], // Use $...$ and \(...)\ for inline math
                displayMath: [['$$', '$$'], ['\\[', '\\]']], // Use $$...$$ and \[...\] for display math
                processEscapes: true, // Allows using \$ for a literal dollar sign
                processEnvironments: true, // Enables LaTeX environments like \begin{align}
            },
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom CSS for spinners and specific elements not easily covered by Tailwind */
        body {
            font-family: sans-serif;
            background-color: #f4f4f4;
        }
        button {
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            box-shadow: 0 3px 1px -2px rgba(0,0,0,.2), 0 2px 2px 0 rgba(0,0,0,.14), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 5px -3px rgba(0,0,0,.2), 0 8px 10px 1px rgba(0,0,0,.14), 0 3px 14px 2px rgba(0,0,0,.12);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,.2), 0 4px 5px 0 rgba(0,0,0,.14), 0 1px 10px 0 rgba(0,0,0,.12);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .large-spinner { /* Used for internal message spinner now */
            width: 20px; /* Smaller for inline use */
            height: 20px;
            border-width: 3px; /* Thinner border */
            border-left-color: #3b82f6; /* Tailwind blue-500 */
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure MathJax elements are properly rendered within the container */
        .chat-container-content { /* New class for content containers */
            min-height: 120px; /* Ensure minimum height for output area */
            line-height: 1.6; /* Tăng khoảng cách dòng để dễ đọc hơn */
            font-size: 1.1rem; /* Tăng kích thước chữ */
            overflow-y: auto; /* Allow vertical scrolling for chat history */
            overflow-x: hidden; /* Prevent horizontal scroll on container itself */
            display: flex; /* Flex container for messages */
            flex-direction: column; /* Stack messages vertically */
        }
        
        /* Message bubble styling */
        .chat-message {
            max-width: 90%; /* Max width for chat bubbles */
            padding: 0.8em 1em;
            border-radius: 0.75em; /* Rounded corners */
            margin-bottom: 0.75em; /* Space between messages */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow for depth */
            word-wrap: break-word; /* Ensure long words break */
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
        }
        .user-message {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-900 */
            align-self: flex-end; /* Align to the right */
        }
        .ai-message {
            background-color: #eff6ff; /* Tailwind blue-100 */
            color: #1e40af; /* Tailwind blue-900 */
            align-self: flex-start; /* Align to the left */
        }

        /* Styling for #responseContent children to improve readability for structured answers */
        /* These styles now apply to content WITHIN .ai-message bubbles */
        .ai-message h1,
        .ai-message h2,
        .ai-message h3,
        .ai-message h4,
        .ai-message h5,
        .ai-message h6 {
            margin-top: 1.2em; /* Add space above headings */
            margin-bottom: 0.6em;
            font-weight: 600; /* Semi-bold */
            color: #2c5282; /* A darker blue for headings */
        }
        .ai-message h3 {
            font-size: 1.4rem; /* Slightly smaller for chat bubble context */
            border-bottom: 1px solid #ebf8ff; /* Light border under h3 */
            padding-bottom: 0.2em;
        }
        .ai-message h4 {
            font-size: 1.2rem; /* Slightly smaller for chat bubble context */
            color: #3182ce; /* A slightly lighter blue for h4 */
        }
        .ai-message p {
            margin-bottom: 0.8em; /* Space between paragraphs */
        }
        .ai-message ul,
        .ai-message ol {
            margin-left: 1.5em; /* Indent lists */
            margin-bottom: 0.8em;
            list-style-position: outside; /* Ensure bullets/numbers are outside content */
        }
        .ai-message li {
            margin-bottom: 0.4em; /* Space between list items */
        }

        /* Enhanced styling for MathJax Display equations within messages */
        .ai-message .MathJax_Display {
            background-color: #e0f2fe; /* Lighter blue background for equations in bubbles */
            border-left: 4px solid #63b3ed; /* Blue left border */
            padding: 0.8em; /* Padding around the equation */
            border-radius: 0.5em; /* Slightly rounded corners */
            margin: 1.2em 0 !important; /* Override default MathJax margin */
            overflow-x: auto; /* Ensure horizontal scrolling for long equations within their box */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow */
        }
        /* Ensure inline math is also readable, though usually MathJax handles this well */
        .ai-message .MathJax_CHTML {
            line-height: 1.2; /* Ensure inline math doesn't affect line height too much */
        }

        /* Back to Top Button Styling (Hidden by default) */
        #backToTopBtn {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px); /* Start slightly down */
        }
        #backToTopBtn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0); /* Slide up to position */
        }

        /* Interactive Link Styling */
        .interactive-link {
            display: inline-block;
            background-color: #e0f2fe; /* Light blue background */
            color: #1e40af; /* Dark blue text */
            padding: 0.2em 0.6em;
            border-radius: 0.3em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: 500;
            border: 1px solid #90cdf4; /* Light blue border */
            text-decoration: none; /* Remove underline for consistency */
            margin: 0.1em; /* Add a small margin for spacing */
        }
        .interactive-link:hover {
            background-color: #bfdbfe; /* Slightly darker blue on hover */
            transform: translateY(-1px); /* Slight lift effect */
        }
        .interactive-link:active {
            transform: translateY(0); /* Return to original position on click */
        }

        /* Completed Topic Styling */
        .interactive-link.completed-topic {
            text-decoration: line-through;
            opacity: 0.7;
            background-color: #dbeafe; /* Lightest blue */
            color: #60a5fa; /* Muted blue */
            border-color: #93c5fd; /* Muted border blue */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center p-5">
    <h1 class="text-4xl font-extrabold text-blue-700 mb-4 text-center">Ứng dụng AI Toán học</h1>
    <h2 class="text-lg text-gray-600 mb-8 text-center">(Sử dụng Gemini 1.5 Flash và MathJax)</h2>

    <!-- Main Chat Content Area -->
    <div class="flex-grow w-full max-w-7xl flex flex-col">
        <!-- Tab Navigation -->
        <div id="tabContainer" class="flex border-b border-gray-200 mb-4 bg-white rounded-t-xl shadow-sm">
            <button id="solutionTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-blue-600 border-b-2 border-blue-600 hover:bg-blue-50 focus:outline-none rounded-tl-xl">
                Lời giải
            </button>
            <button id="reviewTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:bg-blue-50 focus:outline-none rounded-tr-xl">
                Ôn tập
            </button>
        </div>

        <div class="w-full h-full bg-white p-6 rounded-b-xl shadow-lg flex flex-col">
            <!-- Solution Content -->
            <div id="solutionContent" class="flex-grow flex flex-col">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Phản hồi từ AI</h3>
                <div id="solutionResponseContainer"
                     class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content"
                >
                    <!-- Messages will be dynamically added here -->
                    <p id="solutionPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Kết quả sẽ hiển thị ở đây...</p>
                </div>
                <p class="text-sm text-gray-600 mt-4 italic text-center">
                    Để có lời giải chuẩn như sách giáo khoa, hãy yêu cầu AI trình bày chi tiết từng bước và sử dụng LaTeX cho mọi công thức.
                </p>
            </div>

            <!-- Review Content (initially hidden) -->
            <div id="reviewContent" class="flex-grow flex-col hidden">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Lộ trình và Bài tập Ôn tập</h3>
                <div id="reviewResponseContainer"
                     class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content"
                >
                    <p id="reviewPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Nhập yêu cầu để tạo lộ trình ôn tập hoặc câu hỏi...</p>
                </div>
                <p class="text-sm text-gray-600 mt-4 italic text-center">
                    Ví dụ: "Tạo lộ trình ôn tập môn Toán lớp 12 chương Giải tích". Hoặc "Tạo 3 câu hỏi trắc nghiệm về đạo hàm".
                </p>
            </div>
        </div>
    </div>

    <!-- Fixed Input Footer -->
    <div id="chatInputFooter" 
         class="fixed bottom-0 left-0 right-0 w-full bg-white p-4 shadow-xl z-40">
        <div class="max-w-7xl mx-auto">
            <!-- Input and Button Row -->
            <div class="flex items-end space-x-2">
                <textarea id="promptInput" rows="1"
                          class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 resize-y"
                          placeholder="Nhập yêu cầu của bạn..."
                ></textarea>
                <button id="sendPromptButton"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out text-lg font-semibold flex items-center justify-center h-fit"
                >
                    <span id="buttonText">Gửi</span>
                    <div id="buttonSpinner" class="spinner ml-2 hidden"></div>
                </button>
            </div>
            <!-- Status Message (below the input/button row) -->
            <p id="statusMessage" class="status-message text-sm text-center mt-2"></p>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Quay lại đầu trang"
            class="fixed right-5 md:right-8 lg:right-10 
                   bg-blue-600 text-white p-3 rounded-full shadow-lg 
                   hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 
                   transition-all duration-300 ease-in-out text-xl z-50">
        &#x2191; <!-- Unicode for an upward arrow -->
    </button>

    <script type="module">
        // Import các module Firebase cần thiết
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";

        // Cấu hình Firebase của bạn (giữ nguyên như bạn đã cung cấp)
        const firebaseConfig = {
            apiKey: "AIzaSyAI2tN9qy9JqCySLkbTRqgGALlJfuTjg88",
            authDomain: "shopee-3eabb.firebaseapp.com",
            projectId: "shopee-3eabb",
            storageBucket: "shopee-3eabb.firebasestorage.app",
            messagingSenderId: "19651189872",
            appId: "1:19651189872:web:fb0fff66e8c98ceb5928b5"
        };

        // Khởi tạo ứng dụng Firebase
        const app = initializeApp(firebaseConfig);
        console.log("Firebase App initialized!");

        // Lấy các phần tử DOM
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');

        // Tab and Content Elements
        const solutionTabBtn = document.getElementById('solutionTabBtn');
        const reviewTabBtn = document.getElementById('reviewTabBtn');
        const solutionContent = document.getElementById('solutionContent');
        const reviewContent = document.getElementById('reviewContent');
        const solutionResponseContainer = document.getElementById('solutionResponseContainer');
        const reviewResponseContainer = document.getElementById('reviewResponseContainer');
        const solutionPlaceholder = document.getElementById('solutionPlaceholder');
        const reviewPlaceholder = document.getElementById('reviewPlaceholder');

        const chatInputFooter = document.getElementById('chatInputFooter');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Global state for current chat session and content container
        let model;
        let solutionChat;
        let reviewChat;
        let currentChatSession;
        let currentContentContainerElement;
        let currentActiveTab = 'solution'; // Default active tab
        let completedTopics = []; // NEW: Stores prompts of completed learning topics
        let lastUserMessageElement = null; // NEW: Stores reference to the last user message element

        // Constants for quiz and interactive link processing
        const QUIZ_PLACEHOLDER_PREFIX = "QUIZ_PLACEHOLDER_";
        const QUIZ_BLOCK_REGEX = /```(?:quiz|json)\n([\s\S]*?)\n```/g;
        const INTERACTIVE_LINK_REGEX = /(?<!\]\()\B\[(.*?)\]\{(?:\"prompt\":\"(.*?)\")?\}/g;
        const BASIC_LINK_REGEX = /\[(.*?)\]/g;

        const LEARNING_MODE_SYSTEM_PROMPT = `Bạn là một trợ lý ôn tập và học tập AI chuyên biệt trong lĩnh vực toán học. Mục tiêu của bạn là giúp người dùng ôn tập hiệu quả thông qua lộ trình học tập và các nội dung lý thuyết chi tiết.

**Quy tắc phản hồi chính:**
1.  **Lộ trình ôn tập:** Khi người dùng yêu cầu lộ trình ôn tập, bạn phải trả về một danh sách các mục ôn tập dưới dạng Markdown. **Cực kỳ quan trọng: Mỗi mục trong danh sách này phải là một liên kết tương tác với một lời nhắc (prompt) ẩn đi để yêu cầu giải thích lý thuyết chi tiết về mục đó.**
    * **Định dạng liên kết tương tác PHẢI là:** \`[Tên mục ôn tập]{"prompt":"Giải thích chi tiết về [Tên mục ôn tập] bao gồm định nghĩa, công thức, tính chất và các ví dụ minh họa."}\`
    * **Ví dụ về liên kết lý thuyết (TUÂN THỦ NGHIÊM NGẶT):**
        * \`[Đạo hàm cơ bản]{"prompt":"Giải thích chi tiết về đạo hàm cơ bản, định nghĩa, công thức và ví dụ."}\`
        * \`[Số phức cơ bản]{"prompt":"Giải thích về số phức cơ bản, bao gồm định nghĩa, các phép toán và biểu diễn hình học."}\`
2.  **Tạo bài tập/quiz:** Nếu người dùng *trực tiếp* yêu cầu tạo câu hỏi hoặc bài tập, bạn PHẢI trả về một khối JSON hợp lệ được bao bọc trong khối mã Markdown. Nếu người dùng yêu cầu nhiều câu hỏi, bạn có thể trả về một mảng các đối tượng JSON trong một khối mã duy nhất.
    * **Định dạng khối mã PHẢI là:** Khối mã PHẢI bắt đầu bằng \`\`\`quiz trên một dòng riêng và kết thúc bằng \`\`\` trên một dòng riêng. TOÀN BỘ nội dung JSON phải nằm giữa hai dòng này.
    * **Ví dụ định dạng đúng (MỘT ĐỐI TƯỢNG):**
        \`\`\`quiz
        {
            "type": "multiple_choice",
            "title": "Câu hỏi về Đạo hàm",
            "question": "Đạo hàm của hàm số y = $x^3$ là gì?",
            "options": ["$3x^2$", "$x^2$", "$3x$"],
            "answer": "$3x^2$",
            "explanation": "Áp dụng công thức $(x^n)' = n \\cdot x^{n-1}$, ta có $(x^3)' = 3 \\cdot x^{(3-1)} = 3x^2$."
        }
        \`\`\`
    * **Ví dụ định dạng đúng (MẢNG ĐỐI TƯỢNG):**
        \`\`\`quiz
        [
            {
                "type": "multiple_choice",
                "title": "Câu hỏi 1",
                "question": "Câu hỏi đầu tiên?",
                "options": ["A", "B", "C"],
                "answer": "A",
                "explanation": "Giải thích 1."
            },
            {
                "type": "short_answer",
                "title": "Câu hỏi 2",
                "question": "Câu hỏi thứ hai?",
                "answer": "Trả lời",
                "explanation": "Giải thích 2."
            }
        ]
        \`\`\`
    * **Các loại quiz hỗ trợ:** "multiple_choice", "fill_in_the_blank", "short_answer", "flashcard".
    * **Quan trọng:** Các giá trị chuỗi bên trong JSON phải là văn bản thuần túy. **Nếu có biểu thức toán học LaTeX, bạn PHẢI bao bọc chúng bằng dấu đô la (ví dụ: '$E=mc^2$' cho toán nội dòng hoặc '$$x^2+y^2=z^2$$' cho toán hiển thị) để MathJax có thể hiển thị.** Không sử dụng các định dạng Markdown hay HTML khác trong chuỗi JSON.
4.  **Văn bản hỗ trợ:** Bạn có thể xen kẽ văn bản giải thích thông thường (Markdown) giữa các khối.
5.  **Ngôn ngữ:** Luôn phản hồi bằng tiếng Việt.

Hãy tuân thủ nghiêm ngặt các quy tắc trên để đảm bảo trải nghiệm tương tác liền mạch cho người dùng.
`;


        // Hàm cập nhật trạng thái
        function updateStatus(type, message) {
            statusMessage.className = `status-message text-sm ${type}`;
            statusMessage.innerHTML = message;
        }

        updateStatus('text-yellow-600', "Firebase App đã khởi tạo.<br>Đang chờ khởi tạo AI Model...");

        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
            console.log("Generative Model instance created with model 'gemini-1.5-flash'!");
            
            solutionChat = model.startChat(); 
            console.log("Solution chat session started!");

            reviewChat = model.startChat({
                history: [
                    { role: "user", parts: [{ text: LEARNING_MODE_SYSTEM_PROMPT }] },
                    { role: "model", parts: [{ text: "Tôi đã hiểu vai trò của mình là trợ lý ôn tập. Hãy cho tôi biết bạn muốn ôn tập chủ đề gì hoặc tạo câu hỏi như thế nào!" }] }
                ]
            });
            console.log("Review chat session started with learning mode system prompt!");
            
            currentChatSession = solutionChat;
            currentContentContainerElement = solutionResponseContainer;
            
            updateStatus('text-green-600', "Generative Model instance đã tạo. Sẵn sàng gửi yêu cầu.");
        } catch (e) {
            console.error("Lỗi khi khởi tạo AI Model:", e);
            updateStatus('text-red-600', `Lỗi khởi tạo AI Model: ${e.message}.<br>Kiểm tra Console (F12) và đảm bảo Gemini API đã được kích hoạt cho dự án của bạn.`);
        }

        function appendMessage(text, senderType, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', senderType);

            if (isLoading) {
                const spinnerDiv = document.createElement('div');
                spinnerDiv.classList.add('large-spinner');
                messageDiv.appendChild(spinnerDiv);
                messageDiv.spinner = spinnerDiv; // Store reference to spinner
                
                const textSpan = document.createElement('span'); // Span to stream text into
                textSpan.classList.add('ml-3'); // Add some margin from spinner
                messageDiv.appendChild(textSpan);
                messageDiv.streamingTextSpan = textSpan; // Store reference to text span
            } else {
                messageDiv.innerHTML = text;
            }
            
            currentContentContainerElement.appendChild(messageDiv);
            currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
            return messageDiv;
        }

        function extractAndReplaceQuizBlocks(text) {
            const extractedQuizzes = [];
            let quizIndex = 0;
            const cleanedText = text.replace(QUIZ_BLOCK_REGEX, (match, jsonContent) => {
                extractedQuizzes.push(jsonContent.trim());
                return `${QUIZ_PLACEHOLDER_PREFIX}${quizIndex++}`;
            });
            return { cleanedText, extractedQuizzes };
        }

        function preprocessText(text) {
            let processedText = text;
            processedText = processedText.replace(INTERACTIVE_LINK_REGEX, (match, linkText, promptValue) => {
                const decodedPrompt = promptValue ? decodeURIComponent(promptValue) : '';
                const isCompleted = completedTopics.includes(decodedPrompt);
                const completedClass = isCompleted ? ' completed-topic' : '';
                
                const dataAttribute = promptValue ? `data-prompt="${encodeURIComponent(promptValue)}"` : '';
                return `<span class="interactive-link${completedClass}" ${dataAttribute}>${linkText}</span>`;
            });
            return processedText;
        }

        function cleanJSON(jsonString) {
            let cleaned = jsonString.trim();
            cleaned = cleaned.replace(/\/\*[\s\S]*?\*\/|\/\/.*/g, '');
            cleaned = cleaned.replace(/[“”‘’]/g, '"');
            cleaned = cleaned.replace(/,\s*([\}\]])/g, '$1');
            return cleaned;
        }

        function renderQuiz(quizJson, quizIndex) {
            if (!quizJson || !quizJson.type) {
                return `<div class="bg-red-100 text-red-700 p-3 rounded-md my-2">Lỗi: JSON của bài tập không hợp lệ.</div>`;
            }
            let html = `<div class="quiz-block border border-blue-200 rounded-lg p-4 my-3 bg-blue-50">`;
            html += `<p class="font-bold text-blue-800 mb-2">${quizJson.title || 'Bài tập'}</p>`;
            
            switch (quizJson.type) {
                case 'multiple_choice':
                    // No need to wrap with $ here, AI is instructed to do it if math is present
                    const mcqQuestion = quizJson.question || 'Câu hỏi bị thiếu';
                    html += `<p class="mb-2">${mcqQuestion}</p>`;
                    if (quizJson.options && Array.isArray(quizJson.options)) {
                        html += `<div class="space-y-2">`;
                        quizJson.options.forEach((opt, i) => {
                             // No need to wrap each option with $ here
                             const optionText = (typeof opt === 'string' || typeof opt === 'number') ? opt : 'Lựa chọn không hợp lệ';
                             html += `<label class="flex items-center p-2 border rounded-md hover:bg-blue-100 cursor-pointer"><input type="radio" name="mcq-${quizIndex}" value="${i}" class="mr-2">${optionText}</label>`;
                        });
                        html += `</div>`;
                    } else {
                        html += `<div class="text-red-500 text-sm my-2">Lỗi: Không tìm thấy các lựa chọn hoặc định dạng sai cho câu hỏi này.</div>`;
                        console.error('Lỗi dữ liệu Quiz: Thuộc tính "options" bị thiếu hoặc không phải là một mảng.', quizJson);
                    }
                    // No need to wrap answer and explanation with $ here
                    const mcqAnswer = quizJson.answer || 'N/A';
                    const mcqExplanation = quizJson.explanation || '';
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án đúng:</b> ${mcqAnswer}<br><i>${mcqExplanation}</i></p></div>`;
                    break;
                case 'fill_in_the_blank':
                    // No need to wrap question with $ here
                    const fitbQuestion = quizJson.question || '';
                    html += `<p>${fitbQuestion.replace(/__+/g, '<input type="text" class="border-b-2 border-gray-400 focus:border-blue-500 outline-none bg-transparent">')}</p>`;
                    // No need to wrap answer and explanation with $ here
                    const fitbAnswer = quizJson.answer || 'N/A';
                    const fitbExplanation = quizJson.explanation || '';
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án đúng:</b> ${fitbAnswer}<br><i>${fitbExplanation}</i></p></div>`;
                    break;
                case 'short_answer':
                    // No need to wrap question with $ here
                    const saQuestion = quizJson.question || 'Câu hỏi bị thiếu';
                    html += `<p>${saQuestion}</p><textarea class="w-full mt-2 p-2 border rounded-md"></textarea>`;
                    // No need to wrap answer and explanation with $ here
                    const saAnswer = quizJson.answer || 'N/A';
                    const saExplanation = quizJson.explanation || '';
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án gợi ý:</b> ${saAnswer}<br><i>${saExplanation}</i></p></div>`;
                    break;
                case 'flashcard':
                    // No need to wrap front and back with $ here
                    const flashFront = quizJson.front || 'Mặt trước bị thiếu';
                    const flashBack = quizJson.back || 'Mặt sau bị thiếu';
                    html += `<div class="flashcard bg-white p-4 border rounded shadow-sm text-center cursor-pointer">
                                <div class="front"><p class="text-lg font-semibold">${flashFront}</p></div>
                                <div class="back hidden"><p class="text-gray-700">${flashBack}</p></div>
                             </div>`;
                    break;
                default:
                    html += `<p>Loại bài tập không được hỗ trợ: ${quizJson.type}</p>`;
            }
            html += `</div>`;
            return html;
        }

        /**
         * Chèn các khối quiz đã được render vào nội dung HTML.
         * Hàm này có thể xử lý cả đối tượng JSON đơn lẻ và mảng các đối tượng JSON.
         * @param {string} htmlContent - Nội dung HTML chứa các placeholder cho quiz.
         * @param {string[]} extractedQuizzes - Mảng các chuỗi JSON thô được trích xuất.
         * @returns {string} - Nội dung HTML cuối cùng với các quiz đã được render.
         */
        function insertRenderedQuizzes(htmlContent, extractedQuizzes) {
            let finalHtml = htmlContent;
            extractedQuizzes.forEach((quizRaw, index) => {
                const placeholder = `${QUIZ_PLACEHOLDER_PREFIX}${index}`;
                let quizHtml = `<div class="bg-red-100 text-red-700 p-3 rounded-md my-2">Lỗi phân tích JSON quiz. AI có thể đã tạo sai định dạng.</div>`; 

                try {
                    const cleanedQuizRaw = cleanJSON(quizRaw);
                    const parsableQuizRaw = cleanedQuizRaw.replace(/\\/g, '\\\\');
                    const quizData = JSON.parse(parsableQuizRaw);
                    
                    // *** SỬA LỖI: Xử lý trường hợp AI trả về một mảng các quiz ***
                    if (Array.isArray(quizData)) {
                        // Nếu là một mảng, render từng quiz trong mảng
                        quizHtml = quizData.map((quizItem, itemIndex) => {
                            // Tạo một index duy nhất cho mỗi quiz item để radio buttons hoạt động đúng
                            const uniqueIndex = `${index}-${itemIndex}`;
                            return renderQuiz(quizItem, uniqueIndex);
                        }).join(''); // Nối tất cả HTML của các quiz lại với nhau
                    } else {
                        // Nếu là một đối tượng đơn lẻ, render như bình thường
                        quizHtml = renderQuiz(quizData, index);
                    }

                } catch (e) {
                    console.error(`Error parsing or rendering quiz ${index}:`, e, "Raw JSON:", quizRaw);
                }
                finalHtml = finalHtml.replace(placeholder, quizHtml);
            });
            return finalHtml;
        }
        
        function addQuizEventListeners(container) {
            container.querySelectorAll('.quiz-block button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const answerParagraph = e.target.nextElementSibling;
                    if (answerParagraph) {
                        answerParagraph.classList.toggle('hidden');
                        e.target.textContent = answerParagraph.classList.contains('hidden') ? 'Xem đáp án' : 'Ẩn đáp án';
                    }
                });
            });

            container.querySelectorAll('.flashcard').forEach(card => {
                card.addEventListener('click', () => {
                    card.querySelector('.front').classList.toggle('hidden');
                    card.querySelector('.back').classList.toggle('hidden');
                });
            });
        }


        async function handleLearningPromptClick(linkElement) {
            const dataPrompt = linkElement.dataset.prompt;
            if (!dataPrompt) {
                console.warn("Interactive link clicked without data-prompt.");
                return;
            }

            const decodedPrompt = decodeURIComponent(dataPrompt);

            if (!completedTopics.includes(decodedPrompt)) {
                completedTopics.push(decodedPrompt);
                linkElement.classList.add('completed-topic');
            }

            await callGeminiAPI(decodedPrompt);
        }

        async function callGeminiAPI(promptOverride = null) {
            if (!model || !currentChatSession) {
                updateStatus('text-red-600', "Mô hình AI hoặc phiên trò chuyện chưa được khởi tạo.");
                return;
            }

            const promptText = promptOverride || promptInput.value.trim();
            if (!promptText) {
                updateStatus('text-red-600', "Vui lòng nhập lời nhắc!");
                return;
            }

            // Append user message and store its reference
            const userMessageDiv = appendMessage(promptText, 'user-message');
            lastUserMessageElement = userMessageDiv; // Store the reference to the user's message

            if (!promptOverride) {
                promptInput.value = ''; 
            }

            const aiLoadingMessageDiv = appendMessage('', 'ai-message', true); // Pass true for isLoading
            let fullResponseBuffer = ''; // Buffer to accumulate the full response text

            buttonText.textContent = 'Đang gửi...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            try {
                // Use sendMessageStream for streaming responses
                const streamResult = await currentChatSession.sendMessageStream(promptText);

                for await (const chunk of streamResult.stream) {
                    const chunkText = chunk.text();
                    fullResponseBuffer += chunkText;
                    // Append text to the streaming span
                    if (aiLoadingMessageDiv.streamingTextSpan) {
                        aiLoadingMessageDiv.streamingTextSpan.textContent = fullResponseBuffer;
                    }
                    currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight; // Keep scrolling to bottom
                }

                // After the stream completes, remove the spinner
                if (aiLoadingMessageDiv.spinner) {
                    aiLoadingMessageDiv.spinner.remove();
                    aiLoadingMessageDiv.streamingTextSpan.classList.remove('ml-3'); // Remove margin if spinner is gone
                }

                // Process the full accumulated response
                const { cleanedText, extractedQuizzes } = extractAndReplaceQuizBlocks(fullResponseBuffer);
                const preprocessedText = preprocessText(cleanedText);
                let htmlContent = marked.parse(preprocessedText); 
                htmlContent = insertRenderedQuizzes(htmlContent, extractedQuizzes);

                // Update the innerHTML of the message div with the fully processed content
                aiLoadingMessageDiv.innerHTML = htmlContent;

                // Re-typeset MathJax for the new content
                if (typeof MathJax !== 'undefined') {
                    await MathJax.typesetPromise([aiLoadingMessageDiv]);
                } else {
                    console.warn("MathJax is not available.");
                }

                // Add event listeners for interactive links and quizzes to the new content
                aiLoadingMessageDiv.querySelectorAll('.interactive-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleLearningPromptClick(e.currentTarget);
                    });
                });
                addQuizEventListeners(aiLoadingMessageDiv);

                currentContentContainerElement.scrollTop = currentContentContainerElement.scrollTop; // Maintain current scroll
                updateStatus('text-green-600', "Đã nhận phản hồi từ Gemini.");
                console.log("Full response text:", fullResponseBuffer);

            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                // Ensure spinner is removed and error message is displayed even if stream fails midway
                if (aiLoadingMessageDiv.spinner) {
                    aiLoadingMessageDiv.spinner.remove();
                }
                aiLoadingMessageDiv.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}. Vui lòng kiểm tra Console (F12).</p>`;
                currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
                updateStatus('text-red-600', `Lỗi khi gọi Gemini API: ${error.message}.`);
            } finally {
                buttonText.textContent = 'Gửi';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
                promptInput.focus();

                // NEW: Scroll back to the last user message element
                if (lastUserMessageElement) {
                    lastUserMessageElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        function switchTab(tabName) {
            currentActiveTab = tabName;

            solutionContent.classList.add('hidden');
            reviewContent.classList.add('hidden');

            solutionTabBtn.classList.remove('text-blue-600', 'border-blue-600');
            solutionTabBtn.classList.add('text-gray-600', 'border-transparent');
            reviewTabBtn.classList.remove('text-blue-600', 'border-blue-600');
            reviewTabBtn.classList.add('text-gray-600', 'border-transparent');

            if (tabName === 'solution') {
                solutionContent.classList.remove('hidden');
                solutionTabBtn.classList.add('text-blue-600', 'border-blue-600');
                solutionTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = solutionChat;
                currentContentContainerElement = solutionResponseContainer;
            } else if (tabName === 'review') {
                reviewContent.classList.remove('hidden');
                reviewTabBtn.classList.add('text-blue-600', 'border-blue-600');
                reviewTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = reviewChat;
                currentContentContainerElement = reviewResponseContainer;
            }
            
            adjustLayout();
            currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
        }

        if (sendPromptButton) {
            sendPromptButton.addEventListener("click", () => callGeminiAPI(null));
            promptInput.addEventListener("keydown", (event) => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    callGeminiAPI(null);
                }
            });
        } else {
            console.error("Không tìm thấy nút 'sendPromptButton'.");
            updateStatus('text-red-600', "Không tìm thấy nút gửi. Lỗi HTML?");
        }

        if (solutionTabBtn) {
            solutionTabBtn.addEventListener("click", () => switchTab('solution'));
        }
        if (reviewTabBtn) {
            reviewTabBtn.addEventListener("click", () => switchTab('review'));
        }

        function adjustLayout() {
            const footerHeight = chatInputFooter.offsetHeight;
            solutionResponseContainer.style.paddingBottom = `${footerHeight + 20}px`; 
            reviewResponseContainer.style.paddingBottom = `${footerHeight + 20}px`;
            backToTopBtn.style.bottom = `${footerHeight + 20}px`;
        }

        window.addEventListener('load', () => {
            adjustLayout();
            switchTab('solution');
        });
        window.addEventListener('resize', adjustLayout);

        window.addEventListener('scroll', () => {
            if (window.pageYOffset > window.innerHeight / 2) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>
