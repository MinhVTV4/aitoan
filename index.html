<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase AI Logic MVP - Gemini Developer API (1.5 Flash) với MathJax</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax CDN (Configuration before script load) -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']], // Use $...$ and \(...)\ for inline math
                displayMath: [['$$', '$$'], ['\\[', '\\]']], // Use $$...$$ and \[...\\] for display math
                processEscapes: true, // Allows using \$ for a literal dollar sign
                processEnvironments: true, // Enables LaTeX environments like \begin{align}
            },
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom CSS for spinners and specific elements not easily covered by Tailwind */
        body {
            font-family: sans-serif;
            background-color: #f4f4f4;
        }
        button {
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            box-shadow: 0 3px 1px -2px rgba(0,0,0,.2), 0 2px 2px 0 rgba(0,0,0,.14), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 5px -3px rgba(0,0,0,.2), 0 8px 10px 1px rgba(0,0,0,.14), 0 3px 14px 2px rgba(0,0,0,.12);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,.2), 0 4px 5px 0 rgba(0,0,0,.14), 0 1px 10px 0 rgba(0,0,0,.12);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .large-spinner { /* Used for internal message spinner now */
            width: 20px; /* Smaller for inline use */
            height: 20px;
            border-width: 3px; /* Thinner border */
            border-left-color: #3b82f6; /* Tailwind blue-500 */
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure MathJax elements are properly rendered within the container */
        .chat-container-content { /* New class for content containers */
            min-height: 120px; /* Ensure minimum height for output area */
            line-height: 1.6; /* Tăng khoảng cách dòng để dễ đọc hơn */
            font-size: 1.1rem; /* Tăng kích thước chữ */
            overflow-y: auto; /* Allow vertical scrolling for chat history */
            overflow-x: hidden; /* Prevent horizontal scroll on container itself */
            display: flex; /* Flex container for messages */
            flex-direction: column; /* Stack messages vertically */
        }
        
        /* Message bubble styling */
        .chat-message {
            max-width: 90%; /* Max width for chat bubbles */
            padding: 0.8em 1em;
            border-radius: 0.75em; /* Rounded corners */
            margin-bottom: 0.75em; /* Space between messages */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow for depth */
            word-wrap: break-word; /* Ensure long words break */
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
        }
        .user-message {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-900 */
            align-self: flex-end; /* Align to the right */
        }
        .ai-message {
            background-color: #eff6ff; /* Tailwind blue-100 */
            color: #1e40af; /* Tailwind blue-900 */
            align-self: flex-start; /* Align to the left */
        }

        /* Styling for #responseContent children to improve readability for structured answers */
        /* These styles now apply to content WITHIN .ai-message bubbles */
        .ai-message h1,
        .ai-message h2,
        .ai-message h3,
        .ai-message h4,
        .ai-message h5,
        .ai-message h6 {
            margin-top: 1.2em; /* Add space above headings */
            margin-bottom: 0.6em;
            font-weight: 600; /* Semi-bold */
            color: #2c5282; /* A darker blue for headings */
        }
        .ai-message h3 {
            font-size: 1.4rem; /* Slightly smaller for chat bubble context */
            border-bottom: 1px solid #ebf8ff; /* Light border under h3 */
            padding-bottom: 0.2em;
        }
        .ai-message h4 {
            font-size: 1.2rem; /* Slightly smaller for chat bubble context */
            color: #3182ce; /* A slightly lighter blue for h4 */
        }
        .ai-message p {
            margin-bottom: 0.8em; /* Space between paragraphs */
        }
        .ai-message ul,
        .ai-message ol {
            margin-left: 1.5em; /* Indent lists */
            margin-bottom: 0.8em;
            list-style-position: outside; /* Ensure bullets/numbers are outside content */
        }
        .ai-message li {
            margin-bottom: 0.4em; /* Space between list items */
        }

        /* Enhanced styling for MathJax Display equations within messages */
        .ai-message .MathJax_Display {
            background-color: #e0f2fe; /* Lighter blue background for equations in bubbles */
            border-left: 4px solid #63b3ed; /* Blue left border */
            padding: 0.8em; /* Padding around the equation */
            border-radius: 0.5em; /* Slightly rounded corners */
            margin: 1.2em 0 !important; /* Override default MathJax margin */
            overflow-x: auto; /* Ensure horizontal scrolling for long equations within their box */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow */
        }
        /* Ensure inline math is also readable, though usually MathJax handles this well */
        .ai-message .MathJax_CHTML {
            line-height: 1.2; /* Ensure inline math doesn't affect line height too much */
        }

        /* Back to Top Button Styling (Hidden by default) */
        #backToTopBtn {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px); /* Start slightly down */
        }
        #backToTopBtn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0); /* Slide up to position */
        }

        /* Interactive Link Styling */
        .interactive-link {
            display: inline-block;
            background-color: #e0f2fe; /* Light blue background */
            color: #1e40af; /* Dark blue text */
            padding: 0.2em 0.6em;
            border-radius: 0.3em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: 500;
            border: 1px solid #90cdf4; /* Light blue border */
            text-decoration: none; /* Remove underline for consistency */
            margin: 0.1em; /* Add a small margin for spacing */
        }
        .interactive-link:hover {
            background-color: #bfdbfe; /* Slightly darker blue on hover */
            transform: translateY(-1px); /* Slight lift effect */
        }
        .interactive-link:active {
            transform: translateY(0); /* Return to original position on click */
        }

        /* Completed Topic Styling */
        .interactive-link.completed-topic {
            text-decoration: line-through;
            opacity: 0.7;
            background-color: #dbeafe; /* Lightest blue */
            color: #60a5fa; /* Muted blue */
            border-color: #93c5fd; /* Muted border blue */
        }

        /* Saved list item styling */
        .saved-item-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75em 1em;
            margin-bottom: 0.5em;
            background-color: #f0f9ff; /* Tailwind blue-50 */
            border: 1px solid #dbeafe; /* Tailwind blue-100 */
            border-radius: 0.5em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .saved-item-entry:hover {
            background-color: #e0f2fe; /* Tailwind blue-100 */
            transform: translateY(-1px);
        }
        .saved-item-entry:active {
            transform: translateY(0);
        }
        .saved-item-entry .title {
            font-weight: 500;
            color: #1e40af; /* Tailwind blue-900 */
        }
        .saved-item-entry .type {
            font-size: 0.8em;
            color: #60a5fa; /* Tailwind blue-400 */
            background-color: #bfdbfe; /* Tailwind blue-200 */
            padding: 0.2em 0.5em;
            border-radius: 0.25em;
            margin-left: 1em;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center">
    <!-- NEW: Application Header -->
    <header id="headerEl" class="w-full bg-blue-800 text-white p-4 shadow-lg flex flex-col sm:flex-row justify-between items-center z-30">
        <div id="appTitleGroup" class="text-center sm:text-left mb-2 sm:mb-0">
            <h1 class="text-3xl font-extrabold text-white mb-1">Ứng dụng AI Toán học</h1>
            <h2 class="text-md text-blue-200">(Gemini 1.5 Flash & MathJax)</h2>
        </div>
        
        <!-- NEW: User Auth Display & Controls (hidden by default, shown on login) -->
        <div id="userAuthDisplay" class="flex items-center space-x-3 hidden">
            <span id="currentUserEmailDisplay" class="text-sm font-medium text-blue-100"></span>
            <button id="saveSessionBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
                Lưu phiên
            </button>
            <button id="signOutHeaderBtn"
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 text-sm">
                Đăng xuất
            </button>
        </div>
    </header>

    <!-- Authentication Section (Initially visible, hidden on login) -->
    <div id="authSection" class="w-full max-w-md bg-white p-8 rounded-xl shadow-xl mt-8 mb-8">
        <p id="authStatus" class="text-center text-sm mb-4 text-gray-600">Đang tải trạng thái đăng nhập...</p>
        <div id="signInForm" class="space-y-4">
            <div>
                <label for="emailInputAuth" class="block text-sm font-medium text-gray-700">Email:</label>
                <input type="email" id="emailInputAuth" placeholder="your@email.com"
                       class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
            </div>
            <div>
                <label for="passwordInputAuth" class="block text-sm font-medium text-gray-700">Mật khẩu:</label>
                <input type="password" id="passwordInputAuth" placeholder="Mật khẩu của bạn"
                       class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
            </div>
            <div class="flex space-x-2">
                <button id="signInBtn"
                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Đăng nhập
                </button>
                <button id="signUpBtn"
                        class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Đăng ký
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Content (Chat, Tabs, Input) -->
    <div id="mainAppContent" class="flex-grow w-full flex flex-col px-4 md:px-6 lg:px-8 opacity-50 pointer-events-none">
        <!-- Tab Navigation -->
        <div id="tabContainer" class="flex border-b border-gray-200 mb-4 bg-white rounded-t-xl shadow-sm">
            <button id="solutionTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-blue-600 border-b-2 border-blue-600 hover:bg-blue-50 focus:outline-none rounded-tl-xl">
                Lời giải
            </button>
            <button id="reviewTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:bg-blue-50 focus:outline-none">
                Ôn tập
            </button>
            <button id="savedTabBtn" class="flex-1 px-6 py-3 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:bg-blue-50 focus:outline-none rounded-tr-xl">
                Đã lưu
            </button>
        </div>

        <div class="w-full h-full bg-white p-6 rounded-b-xl shadow-lg flex flex-col">
            <!-- Solution Content -->
            <div id="solutionContent" class="flex-grow flex flex-col">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Phản hồi từ AI</h3>
                <div id="solutionResponseContainer"
                     class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content"
                >
                    <!-- Messages will be dynamically added here -->
                    <p id="solutionPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Kết quả sẽ hiển thị ở đây...</p>
                </div>
                <p class="text-sm text-gray-600 mt-4 italic text-center">
                    Để có lời giải chuẩn như sách giáo khoa, hãy yêu cầu AI trình bày chi tiết từng bước và sử dụng LaTeX cho mọi công thức.
                </p>
            </div>

            <!-- Review Content (initially hidden) -->
            <div id="reviewContent" class="flex-grow flex-col hidden">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Lộ trình và Bài tập Ôn tập</h3>
                <div id="reviewResponseContainer"
                     class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content"
                >
                    <p id="reviewPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Nhập yêu cầu để tạo lộ trình ôn tập hoặc câu hỏi...</p>
                </div>
                <p class="text-sm text-gray-600 mt-4 italic text-center">
                    Ví dụ: "Tạo lộ trình ôn tập môn Toán lớp 12 chương Giải tích". Hoặc "Tạo 3 câu hỏi trắc nghiệm về đạo hàm".
                </p>
            </div>

            <!-- NEW: Saved Content (initially hidden) -->
            <div id="savedContent" class="flex-grow flex-col hidden">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Mục đã lưu</h3>
                <div id="savedListContainer" class="flex-grow p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content">
                    <p id="savedPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Bạn chưa lưu mục nào. Hãy lưu các lộ trình hoặc bài tập từ tab "Ôn tập"!</p>
                    <!-- Saved items will be dynamically added here -->
                </div>
                <div id="savedDetailContainer" class="flex-grow flex-col hidden p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-900 relative chat-container-content">
                    <button id="backToSavedListBtn" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm mb-4">← Quay lại danh sách</button>
                    <div id="savedItemDetail">
                        <!-- Detailed content of a saved item will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Input Footer -->
    <div id="chatInputFooter" 
         class="fixed bottom-0 left-0 right-0 w-full bg-white p-4 shadow-xl z-40">
        <div class="px-4 md:px-6 lg:px-8">
            <!-- Input and Button Row -->
            <div class="flex items-end space-x-2">
                <textarea id="promptInput" rows="1"
                          class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 resize-y"
                          placeholder="Nhập yêu cầu của bạn..."
                          disabled
                ></textarea>
                <button id="sendPromptButton"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out text-lg font-semibold flex items-center justify-center h-fit"
                        disabled
                >
                    <span id="buttonText">Gửi</span>
                    <div id="buttonSpinner" class="spinner ml-2 hidden"></div>
                </button>
            </div>
            <!-- Status Message (below the input/button row) -->
            <p id="statusMessage" class="status-message text-sm text-center mt-2"></p>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Quay lại đầu trang"
            class="fixed right-5 md:right-8 lg:right-10 
                   bg-blue-600 text-white p-3 rounded-full shadow-lg 
                   hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 
                   transition-all duration-300 ease-in-out text-xl z-50">
        &#x2191; <!-- Unicode for an upward arrow -->
    </button>

    <script type="module">
        // Import các module Firebase cần thiết
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        // NEW: Import Firebase Authentication modules
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        // NEW: Import Firebase Firestore modules
        import { getFirestore, doc, setDoc, updateDoc, collection, query, orderBy, getDocs, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";


        // Cấu hình Firebase của bạn (giữ nguyên như bạn đã cung cấp)
        const firebaseConfig = {
            apiKey: "AIzaSyANAYB1rV8Zj3_a_9QyQd3gYus2BtGOh-I",
            authDomain: "aitoan.firebaseapp.com",
            projectId: "aitoan",
            storageBucket: "aitoan.firebasestorage.app",
            messagingSenderId: "610699813568",
            appId: "1:610699813568:web:fca3ff4fc698598608c325"
        };

        // Khởi tạo ứng dụng Firebase
        const app = initializeApp(firebaseConfig);
        console.log("Firebase App initialized!");

        // Lấy các phần tử DOM
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');

        // Tab and Content Elements
        const solutionTabBtn = document.getElementById('solutionTabBtn');
        const reviewTabBtn = document.getElementById('reviewTabBtn');
        // NEW: Saved Tab elements
        const savedTabBtn = document.getElementById('savedTabBtn');
        const solutionContent = document.getElementById('solutionContent');
        const reviewContent = document.getElementById('reviewContent');
        const savedContent = document.getElementById('savedContent'); // New Saved content wrapper

        const solutionResponseContainer = document.getElementById('solutionResponseContainer');
        const reviewResponseContainer = document.getElementById('reviewResponseContainer');
        // NEW: Saved Content Containers
        const savedListContainer = document.getElementById('savedListContainer');
        const savedDetailContainer = document.getElementById('savedDetailContainer');
        const savedItemDetail = document.getElementById('savedItemDetail');
        const backToSavedListBtn = document.getElementById('backToSavedListBtn');


        const solutionPlaceholder = document.getElementById('solutionPlaceholder');
        const reviewPlaceholder = document.getElementById('reviewPlaceholder');
        const savedPlaceholder = document.getElementById('savedPlaceholder'); // New saved placeholder


        const chatInputFooter = document.getElementById('chatInputFooter');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Auth DOM Elements for Login Form
        const authSection = document.getElementById('authSection');
        const authStatus = document.getElementById('authStatus');
        const signInForm = document.getElementById('signInForm');
        const emailInputAuth = document.getElementById('emailInputAuth');
        const passwordInputAuth = document.getElementById('passwordInputAuth');
        const signInBtn = document.getElementById('signInBtn');
        const signUpBtn = document.getElementById('signUpBtn');

        // Auth/User Display Elements for Header
        const headerEl = document.getElementById('headerEl');
        const appTitleGroup = document.getElementById('appTitleGroup');
        const userAuthDisplay = document.getElementById('userAuthDisplay');
        const currentUserEmailDisplay = document.getElementById('currentUserEmailDisplay');
        const saveSessionBtn = document.getElementById('saveSessionBtn');
        const signOutHeaderBtn = document.getElementById('signOutHeaderBtn');

        const mainAppContent = document.getElementById('mainAppContent'); // Wrapper for main chat UI

        // Global state for current chat session and content container
        let model;
        let auth; // Firebase Auth instance
        let db; // Firebase Firestore instance
        let currentUserUid = null; // Stores the current user's UID
        let solutionChat = null; // Initialized on auth state change
        let reviewChat = null;   // Initialized on auth state change
        let currentChatSession;
        let currentContentContainerElement;
        let currentActiveTab = 'solution'; // Default active tab
        let completedTopics = []; // Stores prompts of completed learning topics
        let lastUserMessageElement = null; // Stores reference to the last user message element

        // Constants for quiz and interactive link processing
        const QUIZ_PLACEHOLDER_PREFIX = "QUIZ_PLACEHOLDER_";
        const QUIZ_BLOCK_REGEX = /```(?:quiz|json)\n([\s\S]*?)\n```/g;
        const INTERACTIVE_LINK_REGEX = /(?<!\]\()\B\[(.*?)\]\{(?:\"prompt\":\"(.*?)\")?\}/g;
        const LEARNING_PATH_REGEX = /^- \[.*?\]\{"prompt":".*?"\}$/gm; // Regex to detect learning path structure

        const LEARNING_MODE_SYSTEM_PROMPT = `Bạn là một trợ lý ôn tập và học tập AI chuyên biệt trong lĩnh vực toán học. Mục tiêu của bạn là giúp người dùng ôn tập hiệu quả thông qua lộ trình học tập và các nội dung lý thuyết chi tiết.

**Quy tắc phản hồi chính:**
1.  **Lộ trình ôn tập:** Khi người dùng yêu cầu lộ trình ôn tập, bạn phải trả về một danh sách các mục ôn tập dưới dạng Markdown. **Cực kỳ quan trọng: Mỗi mục trong danh sách này phải là một liên kết tương tác với một lời nhắc (prompt) ẩn đi để yêu cầu giải thích lý thuyết chi tiết về mục đó.**
    * **Định dạng liên kết tương tác PHẢI là:** \`[Tên mục ôn tập]{"prompt":"Giải thích chi tiết về [Tên mục ôn tập] bao gồm định nghĩa, công thức, tính chất và các ví dụ minh họa."}\`
    * **Ví dụ về liên kết lý thuyết (TUÂN THỦ NGHIÊM NGẶT):**
        * \`[Đạo hàm cơ bản]{"prompt":"Giải thích chi tiết về đạo hàm cơ bản, định nghĩa, công thức và ví dụ."}\`
        * \`[Số phức cơ bản]{"prompt":"Giải thích về số phức cơ bản, bao gồm định nghĩa, các phép toán và biểu diễn hình học."}\`
2.  **Tạo bài tập/quiz:** Nếu người dùng *trực tiếp* yêu cầu tạo câu hỏi hoặc bài tập, bạn PHẢI trả về một khối JSON hợp lệ được bao bọc trong khối mã Markdown. Nếu người dùng yêu cầu nhiều câu hỏi, bạn có thể trả về một mảng các đối tượng JSON trong một khối mã duy nhất.
    * **Định dạng khối mã PHẢI là:** Khối mã PHẢI bắt đầu bằng \`\`\`quiz trên một dòng riêng và kết thúc bằng \`\`\` trên một dòng riêng. TOÀN BỘ nội dung JSON phải nằm giữa hai dòng này.
    * **Ví dụ định dạng đúng (MỘT ĐỐI TƯỢNG):**
        \`\`\`quiz
        {
            "type": "multiple_choice",
            "title": "Câu hỏi về Đạo hàm",
            "question": "Đạo hàm của hàm số y = $x^3$ là gì?",
            "options": ["$3x^2$", "$x^2$", "$3x$"],
            "answer": "$3x^2$",
            "explanation": "Áp dụng công thức $(x^n)' = n \\cdot x^{n-1}$, ta có $(x^3)' = 3 \\cdot x^{(3-1)} = 3x^2$."
        }
        \`\`\`
    * **Ví dụ định dạng đúng (MẢNG ĐỐI TƯỢNG):**
        \`\`\`quiz
        [
            {
                "type": "multiple_choice",
                "title": "Câu hỏi 1",
                "question": "Câu hỏi đầu tiên?",
                "options": ["A", "B", "C"],
                "answer": "A",
                "explanation": "Giải thích 1."
            },
            {
                "type": "short_answer",
                "title": "Câu hỏi 2",
                "question": "Câu hỏi thứ hai?",
                "answer": "Trả lời",
                "explanation": "Giải thích 2."
            }
        ]
        \`\`\`
    * **Các loại quiz hỗ trợ:** "multiple_choice", "fill_in_the_blank", "short_answer", "flashcard".
    * **Quan trọng:** Các giá trị chuỗi bên trong JSON phải là văn bản thuần túy. **Nếu có biểu thức toán học LaTeX, bạn PHẢI bao bọc chúng bằng dấu đô la (ví dụ: '$E=mc^2$' cho toán nội dòng hoặc '$$x^2+y^2=z^2$$' cho toán hiển thị) để MathJax có thể hiển thị.** Không sử dụng các định dạng Markdown hay HTML khác trong chuỗi JSON.
4.  **Văn bản hỗ trợ:** Bạn có thể xen kẽ văn bản giải thích thông thường (Markdown) giữa các khối.
5.  **Ngôn ngữ:** Luôn phản hồi bằng tiếng Việt.

Hãy tuân thủ nghiêm ngặt các quy tắc trên để đảm bảo trải nghiệm tương tác liền mạch cho người dùng.
`;

        // Hàm cập nhật trạng thái
        function updateStatus(type, message) {
            statusMessage.className = `status-message text-sm ${type}`;
            statusMessage.innerHTML = message;
        }

        // NEW: Function to save an artifact (learning path, quiz, or solution) to Firestore
        async function saveArtifactToFirestore(title, type, rawContent, htmlContent, originalPrompt) {
            if (!currentUserUid || !db) {
                console.warn("Không thể lưu mục: Người dùng chưa đăng nhập hoặc Firestore chưa được khởi tạo.");
                return;
            }
            try {
                await addDoc(collection(db, 'users', currentUserUid, 'saved_artifacts'), {
                    title: title,
                    type: type,
                    rawContent: rawContent,
                    htmlContent: htmlContent,
                    originalPrompt: originalPrompt,
                    createdAt: serverTimestamp()
                });
                updateStatus('text-green-600', `"${title}" đã được lưu vào kho của bạn.`);
                console.log("Mục đã lưu:", { title, type });
            } catch (e) {
                console.error("Lỗi khi lưu mục vào Firestore:", e);
                updateStatus('text-red-600', `Lỗi lưu mục: ${e.message}`);
            }
        }

        // NEW: Function to save user data (active tab, completed topics) to Firestore
        async function saveUserDataToFirestore() {
            if (!currentUserUid || !db) {
                updateStatus('text-red-600', "Không thể lưu dữ liệu: Người dùng chưa đăng nhập hoặc Firestore chưa được khởi tạo.");
                return;
            }
            try {
                // Use setDoc with merge: true to update specific fields without overwriting the entire document
                await setDoc(doc(db, 'users', currentUserUid, 'user_data', 'settings'), {
                    lastActiveTab: currentActiveTab,
                    completedTopics: completedTopics,
                    lastSaved: serverTimestamp()
                }, { merge: true });
                updateStatus('text-green-600', "Dữ liệu phiên đã được lưu thành công!");
                console.log("Dữ liệu người dùng đã lưu vào Firestore.");
            } catch (e) {
                console.error("Lỗi khi lưu dữ liệu người dùng vào Firestore:", e);
                updateStatus('text-red-600', `Lỗi lưu dữ liệu: ${e.message}`);
            }
        }

        // NEW: Placeholder for saving data (now calls saveUserDataToFirestore)
        async function handleSaveSession() {
            await saveUserDataToFirestore();
        }


        // NEW: Authentication functions
        async function handleSignUp() {
            const email = emailInputAuth.value.trim();
            const password = passwordInputAuth.value.trim();

            if (!email || !password) {
                authStatus.textContent = "Vui lòng nhập email và mật khẩu.";
                authStatus.classList.remove('text-green-600', 'text-blue-600');
                authStatus.classList.add('text-red-600');
                return;
            }

            try {
                authStatus.textContent = "Đang đăng ký...";
                authStatus.classList.remove('text-red-600', 'text-green-600');
                authStatus.classList.add('text-blue-600');
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle UI update
                console.log("Đăng ký thành công!");
            } catch (error) {
                console.error("Lỗi đăng ký:", error);
                let errorMessage = "Đăng ký thất bại.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Email này đã được sử dụng. Vui lòng đăng nhập hoặc sử dụng email khác.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Email không hợp lệ.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Mật khẩu quá yếu (ít nhất 6 ký tự).";
                }
                authStatus.textContent = errorMessage;
                authStatus.classList.remove('text-green-600', 'text-blue-600');
                authStatus.classList.add('text-red-600');
            }
        }

        async function handleSignIn() {
            const email = emailInputAuth.value.trim();
            const password = passwordInputAuth.value.trim();

            if (!email || !password) {
                authStatus.textContent = "Vui lòng nhập email và mật khẩu.";
                authStatus.classList.remove('text-green-600', 'text-blue-600');
                authStatus.classList.add('text-red-600');
                return;
            }

            try {
                authStatus.textContent = "Đang đăng nhập...";
                authStatus.classList.remove('text-red-600', 'text-green-600');
                authStatus.classList.add('text-blue-600');
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle UI update
                console.log("Đăng nhập thành công!");
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                let errorMessage = "Đăng nhập thất bại.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Sai email hoặc mật khẩu.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Email không hợp lệ.";
                }
                authStatus.textContent = errorMessage;
                authStatus.classList.remove('text-green-600', 'text-blue-600');
                authStatus.classList.add('text-red-600');
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                console.log("Đăng xuất thành công!");
                // onAuthStateChanged will handle UI update
            } catch (error) {
                console.error("Lỗi đăng xuất:", error);
                // Update authStatus here for sign-out specific errors, if any
                // For a simple sign-out, onAuthStateChanged handles most UI changes.
            }
        }

        // NEW: Function to load saved artifacts from Firestore
        async function loadSavedArtifactsList() {
            if (!currentUserUid || !db) {
                console.warn("Không thể tải mục đã lưu: Người dùng chưa đăng nhập hoặc Firestore chưa được khởi tạo.");
                savedListContainer.innerHTML = `<p id="savedPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Vui lòng đăng nhập để xem các mục đã lưu.</p>`;
                return;
            }

            savedListContainer.innerHTML = ''; // Clear previous list
            savedDetailContainer.classList.add('hidden'); // Hide detail view
            savedListContainer.classList.remove('hidden'); // Show list container

            const loadedArtifacts = [];
            try {
                const artifactsRef = collection(db, 'users', currentUserUid, 'saved_artifacts');
                const q = query(artifactsRef, orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    savedListContainer.innerHTML = `<p id="savedPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Bạn chưa lưu mục nào. Hãy lưu các lộ trình hoặc bài tập từ tab "Ôn tập"!</p>`;
                    return;
                }

                querySnapshot.forEach(doc => {
                    const artifact = { id: doc.id, ...doc.data() };
                    loadedArtifacts.push(artifact);

                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('saved-item-entry');
                    itemDiv.innerHTML = `
                        <span class="title">${artifact.title}</span>
                        <span class="type">${artifact.type === 'learning_path' ? 'Lộ trình' : (artifact.type === 'quiz' ? 'Bài tập' : (artifact.type === 'solution' ? 'Lời giải' : 'Khác'))}</span>
                    `;
                    itemDiv.addEventListener('click', () => displaySavedArtifact(artifact));
                    savedListContainer.appendChild(itemDiv);
                });
                console.log("Mục đã lưu đã tải:", loadedArtifacts);
            } catch (e) {
                console.error("Lỗi khi tải mục đã lưu từ Firestore:", e);
                savedListContainer.innerHTML = `<p id="savedPlaceholder" class="text-red-500 text-center w-full mt-auto mb-auto">Lỗi khi tải mục đã lưu: ${e.message}</p>`;
            }
        }

        // NEW: Function to display a single saved artifact in detail view
        async function displaySavedArtifact(artifact) {
            savedListContainer.classList.add('hidden');
            savedDetailContainer.classList.remove('hidden');
            savedItemDetail.innerHTML = artifact.htmlContent; // Display pre-rendered HTML

            if (typeof MathJax !== 'undefined') {
                await MathJax.typesetPromise([savedItemDetail]);
            } else {
                console.warn("MathJax is not available for saved item detail.");
            }
            addQuizEventListeners(savedItemDetail); // Re-attach quiz event listeners
            savedItemDetail.querySelectorAll('.interactive-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // For saved items, interactive links might trigger new calls.
                    // Decide if you want to allow this or make them read-only.
                    // For now, let's just log or prevent default.
                    console.log("Interactive link clicked in saved item:", link.dataset.prompt);
                    // To make them trigger new sessions like before:
                    // handleLearningPromptClick(e.currentTarget);
                });
            });

            savedDetailContainer.scrollTop = 0; // Scroll to top of detail view
        }

        // NEW: Button to go back from detail view to list view
        backToSavedListBtn.addEventListener('click', () => {
            savedDetailContainer.classList.add('hidden');
            savedListContainer.classList.remove('hidden');
            savedListContainer.scrollTop = 0; // Scroll list to top
        });


        // NEW: Function to load user data and chat history from Firestore
        async function loadUserDataAndChats() {
            if (!currentUserUid || !db) {
                console.warn("Không thể tải dữ liệu: Người dùng chưa đăng nhập hoặc Firestore chưa được khởi tạo.");
                return;
            }

            updateStatus('text-blue-600', "Đang tải dữ liệu phiên...");

            // Clear existing UI messages before loading new ones
            solutionResponseContainer.innerHTML = '';
            reviewResponseContainer.innerHTML = '';
            completedTopics = []; // Clear current topics

            // --- Load User Settings ---
            try {
                const userSettingsRef = doc(db, 'users', currentUserUid, 'user_data', 'settings');
                const userSettingsSnap = await getDoc(userSettingsRef); 
                if (userSettingsSnap.exists()) {
                    const data = userSettingsSnap.data();
                    currentActiveTab = data.lastActiveTab || 'solution';
                    completedTopics = data.completedTopics || [];
                    console.log("Dữ liệu người dùng đã tải:", data);
                } else {
                    console.log("Không tìm thấy dữ liệu cài đặt người dùng.");
                }
            } catch (e) {
                console.error("Lỗi khi tải dữ liệu cài đặt người dùng:", e);
                updateStatus('text-red-600', `Lỗi tải cài đặt: ${e.message}`);
            }

            // --- IMPORTANT FIX: Set the active tab and content container BEFORE appending messages ---
            // This ensures currentContentContainerElement is correctly set before messages are appended.
            switchTab(currentActiveTab); 

            // --- Load Chat Histories (ONLY for re-initializing Gemini chat sessions, not for UI display) ---
            // The UI will be empty based on the user's request, only explicitly saved items will be shown.
            const loadedSolutionHistory = [];
            const loadedReviewHistory = [];
            
            try {
                // Load Solution Chat History (for model context only)
                const solutionMessagesRef = collection(db, 'users', currentUserUid, 'chats', 'solution', 'messages');
                const qSolution = query(solutionMessagesRef, orderBy('timestamp'));
                const solutionQuerySnapshot = await getDocs(qSolution);

                solutionQuerySnapshot.forEach(doc => {
                    const msg = doc.data();
                    loadedSolutionHistory.push({ role: msg.role, parts: [{ text: msg.text }] });
                });
                console.log("Lịch sử chat Lời giải đã tải (cho context AI):", loadedSolutionHistory);

                // Load Review Chat History (for model context only)
                const reviewMessagesRef = collection(db, 'users', currentUserUid, 'chats', 'review', 'messages');
                const qReview = query(reviewMessagesRef, orderBy('timestamp'));
                const reviewQuerySnapshot = await getDocs(qReview);

                reviewQuerySnapshot.forEach(doc => {
                    const msg = doc.data();
                    loadedReviewHistory.push({ role: msg.role, parts: [{ text: msg.text }] });
                });
                console.log("Lịch sử chat Ôn tập đã tải (cho context AI):", loadedReviewHistory);

                // Re-initialize Gemini chat sessions with loaded history
                solutionChat = model.startChat({ history: loadedSolutionHistory });
                reviewChat = model.startChat({
                    history: [
                        { role: "user", parts: [{ text: LEARNING_MODE_SYSTEM_PROMPT }] },
                        { role: "model", parts: [{ text: "Tôi đã hiểu vai trò của mình là trợ lý ôn tập. Hãy cho tôi biết bạn muốn ôn tập chủ đề gì hoặc tạo câu hỏi như thế nào!" }] },
                        ...loadedReviewHistory // Append loaded history after system prompt
                    ]
                });

                // Re-apply completed topic styles after loading - this still makes sense as user progress
                solutionResponseContainer.querySelectorAll('.interactive-link').forEach(link => {
                    const decodedPrompt = decodeURIComponent(link.dataset.prompt);
                    if (completedTopics.includes(decodedPrompt)) {
                        link.classList.add('completed-topic');
                    }
                });
                reviewResponseContainer.querySelectorAll('.interactive-link').forEach(link => {
                    const decodedPrompt = decodeURIComponent(link.dataset.prompt);
                    if (completedTopics.includes(decodedPrompt)) {
                        link.classList.add('completed-topic');
                    }
                });


                // Add event listeners for interactive links and quizzes to the re-rendered content
                // (These will be for newly generated content, not loaded history)
                solutionResponseContainer.querySelectorAll('.interactive-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleLearningPromptClick(e.currentTarget);
                    });
                });
                reviewResponseContainer.querySelectorAll('.interactive-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleLearningPromptClick(e.currentTarget);
                    });
                });
                addQuizEventListeners(solutionResponseContainer);
                addQuizEventListeners(reviewResponseContainer);

                updateStatus('text-green-600', "Dữ liệu phiên đã tải và sẵn sàng.");

            } catch (e) {
                console.error("Lỗi khi tải lịch sử chat từ Firestore:", e);
                updateStatus('text-red-600', `Lỗi tải lịch sử chat: ${e.message}`);
                // Re-init chat sessions with empty history if loading fails
                solutionChat = model.startChat();
                reviewChat = model.startChat({
                    history: [
                        { role: "user", parts: [{ text: LEARNING_MODE_SYSTEM_PROMPT }] },
                        { role: "model", parts: [{ text: "Tôi đã hiểu vai trò của mình là trợ lý ôn tập. Hãy cho tôi biết bạn muốn ôn tập chủ đề gì hoặc tạo câu hỏi như thế nào!" }] }
                    ]
                });
            }
        }


        // NEW: Function to update UI based on auth state
        async function updateAuthUI(user) {
            if (user) {
                // User is signed in
                currentUserUid = user.uid;
                currentUserEmailDisplay.textContent = user.email || 'Ẩn danh'; // Show email in header
                userAuthDisplay.classList.remove('hidden'); // Show user info in header
                userAuthDisplay.classList.add('flex', 'items-center');

                authSection.classList.add('hidden'); // Hide login form
                
                mainAppContent.classList.remove('opacity-50', 'pointer-events-none'); // Enable chat
                promptInput.disabled = false;
                sendPromptButton.disabled = false;
                backToTopBtn.disabled = false;

                updateStatus('text-blue-600', `Chào mừng ${user.email || 'người dùng'}. Đang tải phiên của bạn...`);
                // Call load function after successful login
                await loadUserDataAndChats(); 
                await loadSavedArtifactsList(); // Load saved items too
                updateStatus('text-green-600', `Chào mừng ${user.email || 'người dùng'}. Sẵn sàng gửi yêu cầu.`);
                
            } else {
                // User is signed out
                currentUserUid = null;
                currentUserEmailDisplay.textContent = ''; // Clear email in header
                userAuthDisplay.classList.add('hidden'); // Hide user info in header
                userAuthDisplay.classList.remove('flex', 'items-center');

                authSection.classList.remove('hidden'); // Show login form
                authStatus.textContent = 'Vui lòng đăng nhập hoặc đăng ký.';
                authStatus.classList.remove('text-green-600', 'text-blue-600');
                authStatus.classList.add('text-gray-600');

                // Clear input fields when logging out
                emailInputAuth.value = '';
                passwordInputAuth.value = '';

                mainAppContent.classList.add('opacity-50', 'pointer-events-none'); // Disable chat
                promptInput.disabled = true;
                sendPromptButton.disabled = true;
                backToTopBtn.disabled = true;

                // Clear chat sessions and content
                solutionChat = null; // Ensure sessions are reset
                reviewChat = null;
                solutionResponseContainer.innerHTML = `<p id="solutionPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Kết quả sẽ hiển thị ở đây...</p>`;
                reviewResponseContainer.innerHTML = `<p id="reviewPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Nhập yêu cầu để tạo lộ trình ôn tập hoặc câu hỏi...</p>`;
                savedListContainer.innerHTML = `<p id="savedPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Bạn chưa lưu mục nào. Hãy lưu các lộ trình hoặc bài tập từ tab "Ôn tập"!</p>`;
                savedDetailContainer.classList.add('hidden'); // Ensure detail view is hidden
                completedTopics = []; // Clear completed topics

                updateStatus('text-gray-600', "Bạn cần đăng nhập để bắt đầu.");
                switchTab('solution'); // Default to solution tab and clear it
            }
        }


        // Initial Firebase app and model setup
        updateStatus('text-yellow-600', "Firebase App đã khởi tạo.<br>Đang chờ khởi tạo AI Model và trạng thái đăng nhập...");
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
            console.log("Generative Model instance created!");
            
            // NEW: Init Firestore
            db = getFirestore(app);
            console.log("Firestore DB initialized!");

            // Init Auth and listen for state changes
            auth = getAuth(app);
            onAuthStateChanged(auth, updateAuthUI); // This will trigger updateAuthUI on load

        } catch (e) {
            console.error("Lỗi khi khởi tạo Firebase/AI Model:", e);
            updateStatus('text-red-600', `Lỗi khởi tạo: ${e.message}.<br>Kiểm tra Console (F12) và đảm bảo Firebase/Gemini API đã được kích hoạt.`);
            // Ensure UI is disabled if model fails to init
            mainAppContent.classList.add('opacity-50', 'pointer-events-none');
            promptInput.disabled = true;
            sendPromptButton.disabled = true;
            backToTopBtn.disabled = true;
            authSection.classList.remove('hidden'); // Show auth section so user knows there's an issue
        }

        // Modified appendMessage to optionally save to Firestore
        function appendMessage(text, senderType, isLoading = false) { // Removed saveToFirestore parameter
            // Determine which placeholder to check based on currentContentContainerElement
            let placeholderEl = null;
            if (currentContentContainerElement === solutionResponseContainer && solutionPlaceholder) {
                placeholderEl = solutionPlaceholder;
            } else if (currentContentContainerElement === reviewResponseContainer && reviewPlaceholder) {
                placeholderEl = reviewPlaceholder;
            } else if (currentContentContainerElement === savedListContainer && savedPlaceholder) { // For saved list
                placeholderEl = savedPlaceholder;
            } else if (currentContentContainerElement === savedItemDetail) { // For saved item detail
                // No placeholder to remove here
            }

            if (placeholderEl && placeholderEl.parentNode === currentContentContainerElement) {
                placeholderEl.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', senderType);

            if (isLoading) {
                const spinnerDiv = document.createElement('div');
                spinnerDiv.classList.add('large-spinner');
                messageDiv.appendChild(spinnerDiv);
                
                const textSpan = document.createElement('span'); // Span to stream text into
                textSpan.classList.add('ml-3'); // Add some margin from spinner
                messageDiv.appendChild(textSpan);
                messageDiv.spinner = spinnerDiv; // Store reference to spinner
                messageDiv.streamingTextSpan = textSpan; // Store reference to text span
            } else {
                messageDiv.innerHTML = text;
            }
            
            currentContentContainerElement.appendChild(messageDiv);
            currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
            
            return messageDiv;
        }

        // NEW: Function to add a save button below AI response if it's a learning path or quiz
        function addSaveArtifactButton(aiMessageDiv, rawResponse, originalPrompt) {
            let artifactType = null;
            let artifactTitle = null;

            // Check for Quiz block
            const quizMatch = rawResponse.match(QUIZ_BLOCK_REGEX);
            if (quizMatch) {
                artifactType = 'quiz';
                try {
                    const cleanedQuizRaw = cleanJSON(quizMatch[0]); // Use full match including ```quiz```
                    const parsableQuizRaw = cleanedQuizRaw.replace(/\\/g, '\\\\');
                    const quizData = JSON.parse(parsableQuizRaw.replace('```quiz\n', '').replace('\n```', ''));
                    // If it's an array of quizzes, try to get the title of the first one or a generic title
                    if (Array.isArray(quizData) && quizData.length > 0) {
                        artifactTitle = quizData[0].title || `Bài tập (${new Date().toLocaleDateString()})`;
                    } else if (quizData.title) { // Single quiz object
                        artifactTitle = quizData.title;
                    } else {
                         artifactTitle = `Bài tập (${new Date().toLocaleDateString()})`;
                    }
                } catch (e) {
                    console.error("Error parsing quiz JSON for title:", e);
                    artifactTitle = `Bài tập (${new Date().toLocaleDateString()})`;
                }
            } 
            // Check for Learning Path (list of interactive links)
            else if (rawResponse.match(LEARNING_PATH_REGEX)) {
                artifactType = 'learning_path';
                // Try to derive title from the original prompt if it was a "roadmap" request
                if (originalPrompt && originalPrompt.toLowerCase().includes('lộ trình ôn tập')) {
                    artifactTitle = originalPrompt.replace(/tạo|vẽ|cho tôi|giúp tôi|lên|một\s|về\s|chi tiết\s/gi, '').trim();
                    if (artifactTitle.length > 50) artifactTitle = artifactTitle.substring(0, 47) + '...';
                } else {
                    artifactTitle = `Lộ trình học (${new Date().toLocaleDateString()})`;
                }
            }

            if (artifactType) {
                const saveButton = document.createElement('button');
                saveButton.classList.add(
                    'bg-purple-600', 'hover:bg-purple-700', 'text-white', 'font-semibold',
                    'py-1', 'px-2', 'rounded-md', 'shadow-sm', 'text-sm', 'mt-2', 'mr-2', 'ml-auto' // float right
                );
                saveButton.textContent = `Lưu ${artifactType === 'learning_path' ? 'Lộ trình' : 'Bài tập'}`;
                saveButton.addEventListener('click', async () => {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Đang lưu...';
                    await saveArtifactToFirestore(
                        artifactTitle,
                        artifactType,
                        rawResponse, // Save the full raw text for re-rendering
                        aiMessageDiv.innerHTML, // Save the rendered HTML as well
                        originalPrompt
                    );
                    saveButton.textContent = 'Đã lưu!';
                    saveButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    saveButton.classList.add('bg-gray-400');
                });
                const container = aiMessageDiv.parentNode;
                const saveButtonWrapper = document.createElement('div');
                saveButtonWrapper.classList.add('flex', 'justify-end', 'w-full', 'pr-2'); // Align right
                container.insertBefore(saveButtonWrapper, aiMessageDiv.nextSibling); // Insert after the message
                saveButtonWrapper.appendChild(saveButton);
            }
        }

        // NEW: Function to add a save button for solutions in the "Lời giải" tab
        function addSaveSolutionButton(aiMessageDiv, rawResponse, originalPrompt) {
            const saveButton = document.createElement('button');
            saveButton.classList.add(
                'bg-purple-600', 'hover:bg-purple-700', 'text-white', 'font-semibold',
                'py-1', 'px-2', 'rounded-md', 'shadow-sm', 'text-sm', 'mt-2', 'mr-2', 'ml-auto' // float right
            );
            saveButton.textContent = `Lưu lời giải này`;
            saveButton.addEventListener('click', async () => {
                saveButton.disabled = true;
                saveButton.textContent = 'Đang lưu...';
                const solutionTitle = originalPrompt ? `Lời giải cho "${originalPrompt.substring(0, 40)}${originalPrompt.length > 40 ? '...' : ''}"` : `Lời giải (${new Date().toLocaleDateString()})`;
                await saveArtifactToFirestore(
                    solutionTitle,
                    'solution', // Type for saved solution
                    rawResponse,
                    aiMessageDiv.innerHTML,
                    originalPrompt
                );
                saveButton.textContent = 'Đã lưu!';
                saveButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                saveButton.classList.add('bg-gray-400');
            });
            const container = aiMessageDiv.parentNode;
            const saveButtonWrapper = document.createElement('div');
            saveButtonWrapper.classList.add('flex', 'justify-end', 'w-full', 'pr-2'); // Align right
            container.insertBefore(saveButtonWrapper, aiMessageDiv.nextSibling); // Insert after the message
            saveButtonWrapper.appendChild(saveButton);
        }


        function extractAndReplaceQuizBlocks(text) {
            const extractedQuizzes = [];
            let quizIndex = 0;
            const cleanedText = text.replace(QUIZ_BLOCK_REGEX, (match, jsonContent) => {
                extractedQuizzes.push(jsonContent.trim());
                return `${QUIZ_PLACEHOLDER_PREFIX}${quizIndex++}`;
            });
            return { cleanedText, extractedQuizzes };
        }

        function preprocessText(text) {
            let processedText = text;
            processedText = processedText.replace(INTERACTIVE_LINK_REGEX, (match, linkText, promptValue) => {
                const decodedPrompt = promptValue ? decodeURIComponent(promptValue) : '';
                const isCompleted = completedTopics.includes(decodedPrompt);
                const completedClass = isCompleted ? ' completed-topic' : '';
                
                const dataAttribute = promptValue ? `data-prompt="${encodeURIComponent(promptValue)}"` : '';
                return `<span class="interactive-link${completedClass}" ${dataAttribute}>${linkText}</span>`;
            });
            return processedText;
        }

        function cleanJSON(jsonString) {
            let cleaned = jsonString.trim();
            cleaned = cleaned.replace(/\/\*[\s\S]*?\*\/|\/\/.*/g, '');
            cleaned = cleaned.replace(/[“”‘’]/g, '"');
            cleaned = cleaned.replace(/,\s*([\}\]])/g, '$1');
            return cleaned;
        }

        function renderQuiz(quizJson, quizIndex) {
            if (!quizJson || !quizJson.type) {
                return `<div class="bg-red-100 text-red-700 p-3 rounded-lg my-2">Lỗi: JSON của bài tập không hợp lệ.</div>`;
            }
            let html = `<div class="quiz-block border border-blue-200 rounded-lg p-4 my-3 bg-blue-50">`;
            html += `<p class="font-bold text-blue-800 mb-2">${quizJson.title || 'Bài tập'}</p>`;
            
            switch (quizJson.type) {
                case 'multiple_choice':
                    // No need to wrap with $ here, AI is instructed to do it if math is present
                    const mcqQuestion = quizJson.question || 'Câu hỏi bị thiếu';
                    html += `<p class="mb-2">${mcqQuestion}</p>`;
                    if (quizJson.options && Array.isArray(quizJson.options)) {
                        html += `<div class="space-y-2">`;
                        quizJson.options.forEach((opt, i) => {
                             // No need to wrap each option with $ here
                             const optionText = (typeof opt === 'string' || typeof opt === 'number') ? opt : 'Lựa chọn không hợp lệ';
                             html += `<label class="flex items-center p-2 border rounded-lg hover:bg-blue-100 cursor-pointer"><input type="radio" name="mcq-${quizIndex}" value="${i}" class="mr-2">${optionText}</label>`;
                        });
                        html += `</div>`;
                    } else {
                        html += `<div class="text-red-500 text-sm my-2">Lỗi: Không tìm thấy các lựa chọn hoặc định dạng sai cho câu hỏi này.</div>`;
                        console.error('Lỗi dữ liệu Quiz: Thuộc tính "options" bị thiếu hoặc không phải là một mảng.', quizJson);
                    }
                    // No need to wrap answer and explanation with $ here
                    const mcqAnswer = quizJson.answer || 'N/A';
                    const mcqExplanation = quizJson.explanation || '';
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án đúng:</b> ${mcqAnswer}<br><i>${mcqExplanation}</i></p></div>`;
                    break;
                case 'fill_in_the_blank':
                    // No need to wrap question with $ here
                    const fitbQuestion = quizJson.question || '';
                    html += `<p>${fitbQuestion.replace(/__+/g, '<input type="text" class="border-b-2 border-gray-400 focus:border-blue-500 outline-none bg-transparent">')}</p>`;
                    // No need to wrap answer and explanation with $ here
                    const fitbAnswer = quizJson.answer || 'N/A';
                    const fitbExplanation = quizJson.explanation || '';
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án đúng:</b> ${fitbAnswer}<br><i>${fitbExplanation}</i></p></div>`;
                    break;
                case 'short_answer':
                    // No need to wrap question with $ here
                    const saQuestion = quizJson.question || 'Câu hỏi bị thiếu';
                    html += `<p>${saQuestion}</p><textarea class="w-full mt-2 p-2 border rounded-lg"></textarea>`;
                    // No need to wrap answer and explanation with $ here
                    const saAnswer = quizJson.answer || 'N/A';
                    const saExplanation = quizJson.explanation || '';
                    html += `<div class="mt-3"><button class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Xem đáp án</button><p class="text-green-700 mt-2 hidden"><b>Đáp án gợi ý:</b> ${saAnswer}<br><i>${saExplanation}</i></p></div>`;
                    break;
                case 'flashcard':
                    // No need to wrap front and back with $ here
                    const flashFront = quizJson.front || 'Mặt trước bị thiếu';
                    const flashBack = quizJson.back || 'Mặt sau bị thiếu';
                    html += `<div class="flashcard bg-white p-4 border rounded-lg shadow-sm text-center cursor-pointer">
                                <div class="front"><p class="text-lg font-semibold">${flashFront}</p></div>
                                <div class="back hidden"><p class="text-gray-700">${flashBack}</p></div>
                             </div>`;
                    break;
                default:
                    html += `<p>Loại bài tập không được hỗ trợ: ${quizJson.type}</p>`;
            }
            html += `</div>`;
            return html;
        }

        /**
         * Chèn các khối quiz đã được render vào nội dung HTML.
         * Hàm này có thể xử lý cả đối tượng JSON đơn lẻ và mảng các đối tượng JSON.
         * @param {string} htmlContent - Nội dung HTML chứa các placeholder cho quiz.
         * @param {string[]} extractedQuizzes - Mảng các chuỗi JSON thô được trích xuất.
         * @returns {string} - Nội dung HTML cuối cùng với các quiz đã được render.
         */
        function insertRenderedQuizzes(htmlContent, extractedQuizzes) {
            let finalHtml = htmlContent;
            extractedQuizzes.forEach((quizRaw, index) => {
                const placeholder = `${QUIZ_PLACEHOLDER_PREFIX}${index}`;
                let quizHtml = `<div class="bg-red-100 text-red-700 p-3 rounded-lg my-2">Lỗi phân tích JSON quiz. AI có thể đã tạo sai định dạng.</div>`; 

                try {
                    const cleanedQuizRaw = cleanJSON(quizRaw);
                    const parsableQuizRaw = cleanedQuizRaw.replace(/\\/g, '\\\\');
                    const quizData = JSON.parse(parsableQuizRaw);
                    
                    // *** SỬA LỖI: Xử lý trường hợp AI trả về một mảng các quiz ***
                    if (Array.isArray(quizData)) {
                        // Nếu là một mảng, render từng quiz trong mảng
                        quizHtml = quizData.map((quizItem, itemIndex) => {
                            // Tạo một index duy nhất cho mỗi quiz item để radio buttons hoạt động đúng
                            const uniqueIndex = `${index}-${itemIndex}`;
                            return renderQuiz(quizItem, uniqueIndex);
                        }).join(''); // Nối tất cả HTML của các quiz lại với nhau
                    } else {
                        // Nếu là một đối tượng đơn lẻ, render như bình thường
                        quizHtml = renderQuiz(quizData, index);
                    }

                } catch (e) {
                    console.error(`Error parsing or rendering quiz ${index}:`, e, "Raw JSON:", quizRaw);
                }
                finalHtml = finalHtml.replace(placeholder, quizHtml);
            });
            return finalHtml;
        }
        
        function addQuizEventListeners(container) {
            container.querySelectorAll('.quiz-block button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const answerParagraph = e.target.nextElementSibling;
                    if (answerParagraph) {
                        answerParagraph.classList.toggle('hidden');
                        e.target.textContent = answerParagraph.classList.contains('hidden') ? 'Xem đáp án' : 'Ẩn đáp án';
                    }
                });
            });

            container.querySelectorAll('.flashcard').forEach(card => {
                card.addEventListener('click', () => {
                    card.querySelector('.front').classList.toggle('hidden');
                    card.querySelector('.back').classList.toggle('hidden');
                });
            });
        }


        async function handleLearningPromptClick(linkElement) {
            const dataPrompt = linkElement.dataset.prompt;
            if (!dataPrompt) {
                console.warn("Interactive link clicked without data-prompt.");
                return;
            }

            const decodedPrompt = decodeURIComponent(dataPrompt);

            if (!completedTopics.includes(decodedPrompt)) {
                completedTopics.push(decodedPrompt);
                linkElement.classList.add('completed-topic');
                // NEW: Also save user data when a topic is completed
                await saveUserDataToFirestore();
            }

            await callGeminiAPI(decodedPrompt);
        }

        async function callGeminiAPI(promptOverride = null) {
            // NEW: Check if user is logged in
            if (!currentUserUid || !model || !currentChatSession) {
                updateStatus('text-red-600', "Bạn cần đăng nhập để sử dụng tính năng này.");
                return;
            }

            const promptText = promptOverride || promptInput.value.trim();
            if (!promptText) {
                updateStatus('text-red-600', "Vui lòng nhập lời nhắc!");
                return;
            }

            // Append user message and store its reference
            const userMessageDiv = appendMessage(promptText, 'user-message', false); // User message is not loading
            lastUserMessageElement = userMessageDiv; // Store the reference to the user's message

            // NO LONGER AUTOMATICALLY SAVE USER MESSAGES TO FIRESTORE
            // saveMessageToFirestore(currentActiveTab, 'user', promptText, userMessageDiv.innerHTML);


            if (!promptOverride) {
                promptInput.value = ''; 
            }

            const aiLoadingMessageDiv = appendMessage('', 'ai-message', true); // Pass true for isLoading
            let fullResponseBuffer = ''; // Buffer to accumulate the full response text

            buttonText.textContent = 'Đang gửi...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            try {
                // Use sendMessageStream for streaming responses
                const streamResult = await currentChatSession.sendMessageStream(promptText);

                for await (const chunk of streamResult.stream) {
                    const chunkText = chunk.text();
                    fullResponseBuffer += chunkText;
                    // Append text to the streaming span
                    if (aiLoadingMessageDiv.streamingTextSpan) {
                        aiLoadingMessageDiv.streamingTextSpan.textContent = fullResponseBuffer;
                    }
                    currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight; // Keep scrolling to bottom
                }

                // After the stream completes, remove the spinner
                if (aiLoadingMessageDiv.spinner) {
                    aiLoadingMessageDiv.spinner.remove();
                    aiLoadingMessageDiv.streamingTextSpan.classList.remove('ml-3'); // Remove margin if spinner is gone
                }

                // Process the full accumulated response
                const { cleanedText, extractedQuizzes } = extractAndReplaceQuizBlocks(fullResponseBuffer);
                const preprocessedText = preprocessText(cleanedText);
                let htmlContent = marked.parse(preprocessedText); 
                htmlContent = insertRenderedQuizzes(htmlContent, extractedQuizzes);

                // Update the innerHTML of the message div with the fully processed content
                aiLoadingMessageDiv.innerHTML = htmlContent;

                // Re-typeset MathJax for the new content
                if (typeof MathJax !== 'undefined') {
                    await MathJax.typesetPromise([aiLoadingMessageDiv]);
                } else {
                    console.warn("MathJax is not available.");
                }

                // Add event listeners for interactive links and quizzes to the new content
                aiLoadingMessageDiv.querySelectorAll('.interactive-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleLearningPromptClick(e.currentTarget);
                    });
                });
                addQuizEventListeners(aiLoadingMessageDiv);

                currentContentContainerElement.scrollTop = currentContentContainerElement.scrollTop; // Maintain current scroll
                updateStatus('text-green-600', "Đã nhận phản hồi từ Gemini.");
                console.log("Full response text:", fullResponseBuffer);

                // NO LONGER AUTOMATICALLY SAVE AI MESSAGES TO FIRESTORE
                // saveMessageToFirestore(currentActiveTab, 'model', fullResponseBuffer, htmlContent);

                // NEW: Add save artifact button if applicable
                if (currentActiveTab === 'review') {
                    addSaveArtifactButton(aiLoadingMessageDiv, fullResponseBuffer, promptText);
                } else if (currentActiveTab === 'solution') { // NEW: Add save button for solutions
                    addSaveSolutionButton(aiLoadingMessageDiv, fullResponseBuffer, promptText);
                }


            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                // Ensure spinner is removed and error message is displayed even if stream fails midway
                if (aiLoadingMessageDiv.spinner) {
                    aiLoadingMessageDiv.spinner.remove();
                }
                aiLoadingMessageDiv.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}. Vui lòng kiểm tra Console (F12).</p>`;
                currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
                updateStatus('text-red-600', `Lỗi khi gọi Gemini API: ${error.message}.`);
            } finally {
                buttonText.textContent = 'Gửi';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
                promptInput.focus();

                // NEW: Scroll back to the last user message element (after rendering)
                if (lastUserMessageElement) {
                    lastUserMessageElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        function switchTab(tabName) {
            // NEW: Save current active tab when switching
            if (currentActiveTab !== tabName && currentUserUid) {
                saveUserDataToFirestore(); // Save previous state before switching
            }
            currentActiveTab = tabName;

            solutionContent.classList.add('hidden');
            reviewContent.classList.add('hidden');
            savedContent.classList.add('hidden'); // NEW: Hide saved content

            solutionTabBtn.classList.remove('text-blue-600', 'border-blue-600');
            solutionTabBtn.classList.add('text-gray-600', 'border-transparent');
            reviewTabBtn.classList.remove('text-blue-600', 'border-blue-600');
            reviewTabBtn.classList.add('text-gray-600', 'border-transparent');
            savedTabBtn.classList.remove('text-blue-600', 'border-blue-600'); // NEW
            savedTabBtn.classList.add('text-gray-600', 'border-transparent'); // NEW

            if (tabName === 'solution') {
                solutionContent.classList.remove('hidden');
                solutionTabBtn.classList.add('text-blue-600', 'border-blue-600');
                solutionTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = solutionChat;
                currentContentContainerElement = solutionResponseContainer;
                // Ensure placeholder visibility if no messages and no child nodes
                if (solutionResponseContainer.children.length === 0) {
                    solutionResponseContainer.innerHTML = `<p id="solutionPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Kết quả sẽ hiển thị ở đây...</p>`;
                }
            } else if (tabName === 'review') {
                reviewContent.classList.remove('hidden');
                reviewTabBtn.classList.add('text-blue-600', 'border-blue-600');
                reviewTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = reviewChat;
                currentContentContainerElement = reviewResponseContainer;
                // Ensure placeholder visibility if no messages and no child nodes
                if (reviewResponseContainer.children.length === 0) {
                    reviewResponseContainer.innerHTML = `<p id="reviewPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Nhập yêu cầu để tạo lộ trình ôn tập hoặc câu hỏi...</p>`;
                }
            } else if (tabName === 'saved') { // NEW: Handle saved tab
                savedContent.classList.remove('hidden');
                savedTabBtn.classList.add('text-blue-600', 'border-blue-600');
                savedTabBtn.classList.remove('text-gray-600', 'border-transparent');
                currentChatSession = null; // No active chat session in saved tab
                currentContentContainerElement = savedListContainer; // Initially show the list

                // Always reload saved items when switching to this tab
                if (currentUserUid) {
                    loadSavedArtifactsList();
                } else {
                    savedListContainer.innerHTML = `<p id="savedPlaceholder" class="text-gray-500 text-center w-full mt-auto mb-auto">Vui lòng đăng nhập để xem các mục đã lưu.</p>`;
                }
            }
            
            adjustLayout();
            currentContentContainerElement.scrollTop = currentContentContainerElement.scrollHeight;
        }

        // Add event listeners for auth buttons
        signInBtn.addEventListener('click', handleSignIn);
        signUpBtn.addEventListener('click', handleSignUp);
        // Sign out button in header
        signOutHeaderBtn.addEventListener('click', handleSignOut);
        // Save session button
        saveSessionBtn.addEventListener('click', handleSaveSession);
        // NEW: Saved tab button
        savedTabBtn.addEventListener('click', () => switchTab('saved'));


        if (sendPromptButton) {
            sendPromptButton.addEventListener("click", () => callGeminiAPI(null));
            promptInput.addEventListener("keydown", (event) => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    callGeminiAPI(null);
                }
            });
        } else {
            console.error("Không tìm thấy nút 'sendPromptButton'.");
            updateStatus('text-red-600', "Không tìm thấy nút gửi. Lỗi HTML?");
        }

        if (solutionTabBtn) {
            solutionTabBtn.addEventListener("click", () => switchTab('solution'));
        }
        if (reviewTabBtn) {
            reviewTabBtn.addEventListener("click", () => switchTab('review'));
        }

        function adjustLayout() {
            const footerHeight = chatInputFooter.offsetHeight;
            solutionResponseContainer.style.paddingBottom = `${footerHeight + 20}px`; 
            reviewResponseContainer.style.paddingBottom = `${footerHeight + 20}px`;
            // NEW: Add padding for saved content containers
            savedListContainer.style.paddingBottom = `${footerHeight + 20}px`;
            savedDetailContainer.style.paddingBottom = `${footerHeight + 20}px`;
            backToTopBtn.style.bottom = `${footerHeight + 20}px`;
        }

        window.addEventListener('load', () => {
            adjustLayout();
            // switchTab('solution') is now called by updateAuthUI after auth state is determined
        });
        window.addEventListener('resize', adjustLayout);

        window.addEventListener('scroll', () => {
            if (window.pageYOffset > window.innerHeight / 2) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>
